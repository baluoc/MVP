<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TK Event Zentrale</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/app.css" rel="stylesheet">
</head>
<body>

    <div class="sidebar">
        <div class="brand"><span>TK</span> EVENT SERVER</div>

        <div class="nav-group">Monitoring</div>
        <div class="nav-item active" onclick="showView('dashboard')" data-view="dashboard" data-testid="nav-dashboard">üìä Live √úbersicht</div>
        <div class="nav-item" onclick="showView('users')" data-view="users" data-testid="nav-users">üìà Statistiken / DB</div>

        <div class="nav-group">Konfiguration</div>
        <div class="nav-item nav-sub" onclick="showView('settings-system')" data-view="settings-system" data-testid="nav-system">System</div>
        <div class="nav-item nav-sub" onclick="showView('settings-points')" data-view="settings-points" data-testid="nav-points">Punkte & Level</div>
        <div class="nav-item nav-sub" onclick="showView('settings-broadcast')" data-view="settings-broadcast" data-testid="nav-broadcast">Broadcast</div>
        <div class="nav-item nav-sub" onclick="showView('settings-chat')" data-view="settings-chat" data-testid="nav-chat">Chat</div>
        <div class="nav-item nav-sub" onclick="showView('settings-commands')" data-view="settings-commands" data-testid="nav-commands">Befehle</div>
        <div class="nav-item nav-sub" onclick="showView('settings-tts')" data-view="settings-tts" data-testid="nav-tts">TTS</div>
        <div class="nav-item nav-sub" onclick="showView('settings-gifts')" data-view="settings-gifts" data-testid="nav-gifts">Geschenke / Assets</div>

        <div class="nav-group">Overlay</div>
        <div class="nav-item nav-sub" onclick="showView('overlays')" data-view="overlays" data-testid="nav-overlays">Overlays</div>
        <div class="nav-item nav-sub" onclick="showView('overlay-composer')" data-view="overlay-composer" data-testid="nav-composer">Overlay-Composer</div>

        <div class="nav-group">Entwicklung</div>
        <div class="nav-item nav-sub" onclick="showView('mcp')" data-view="mcp" data-testid="nav-mcp">MCP Workshop</div>


        <div style="margin-top: auto; padding-top:20px; border-top:1px solid var(--border);">
            <div style="font-size: 0.75rem; color: var(--muted); margin-bottom: 5px;">VERBINDUNG</div>
            <div style="display:flex; align-items:center; gap:8px;">
                <div id="status-dot" style="width: 8px; height: 8px; background: #666; border-radius: 50%;"></div>
                <span id="status-text" style="font-size: 0.85rem; color: #999;" data-testid="status-text">Offline</span>
            </div>
            <div id="status-meta" style="font-size: 0.7rem; color: var(--muted); margin-top: 4px;"></div>
        </div>
    </div>

    <div class="main">
        <!-- Top Bar -->
        <div style="height: 50px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: var(--bg);">
            <div style="display:flex; align-items:center; gap:15px;">
                <div style="font-weight: 600; font-size: 0.9rem;" id="page-title" data-testid="page-title">Live √úbersicht</div>
                <div id="live-badge" class="live-badge inactive" data-testid="live-badge">OFFLINE</div>
            </div>

            <div style="display:flex; gap:10px; align-items: center;">
                <button class="btn-primary" id="btn-save" onclick="saveSettings()" style="display:none;" data-testid="btn-save">√Ñnderungen speichern</button>

                <!-- Connection UI now simplified or in modal? Let's keep a compact version here for usability -->
                <div id="connect-ui-compact" style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:0.8rem; color:var(--muted); text-align:right; line-height:1.1;">
                        Verbindungs-User<br><strong id="top-conn-user" style="color:var(--text); cursor:pointer;" onclick="openConnectModal()">@Nicht Verbunden</strong>
                    </span>
                    <button class="btn-icon" onclick="openConnectModal()">‚öôÔ∏è</button>
                </div>
            </div>
        </div>

        <!-- DASHBOARD (Rich UI) -->
        <div id="view-dashboard" class="view active" data-testid="view-dashboard" style="overflow:hidden;">
            <div class="dashboard-grid">

                <!-- Col 1: Live Vorschau -->
                <div style="display:flex; flex-direction:column; gap:15px;">
                    <div style="display:flex; justify-content:flex-end;">
                        <button class="btn-secondary" style="font-size:0.7rem; padding:4px 8px;" onclick="showView('mcp')">MCP √∂ffnen</button>
                    </div>
                    <div class="stage-container-preview" id="preview-container">
                        <div class="stage-overlay-label">TIKTOK OUTPUT</div>
                        <iframe id="preview-frame" class="stage-iframe" src="about:blank"></iframe>
                        <div class="stage-overlay-label bottom">LIVE FEED (1080x1920)</div>
                        <!-- Mock Overlay Bubble -->
                        <div class="mock-bubble" id="mock-preview-bubble">
                            <strong>@user123</strong>
                            <span>Das ist eine Vorschau des Overlays.</span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><span class="card-title">LIVE METRIKEN</span></div>
                        <div class="card-body" style="flex-direction:row; justify-content:space-around;">
                            <div style="text-align:center;">
                                <div style="font-size:0.75rem; color:var(--muted); text-transform:uppercase;">Zuschauer</div>
                                <div style="font-size:1.5rem; font-weight:bold; color:var(--text);" id="metric-viewers">0</div>
                            </div>
                            <div style="text-align:center;">
                                <div style="font-size:0.75rem; color:var(--muted); text-transform:uppercase;">Likes</div>
                                <div style="font-size:1.5rem; font-weight:bold; color:var(--primary);">0</div> <!-- Stub for Likes -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Col 2: Live Chat -->
                <div class="card" data-testid="card-chat-stream" style="height:100%;">
                    <div class="card-header">
                        <span class="card-title">Live Chat</span>
                        <span style="background:var(--panel); font-size:0.7rem; padding:2px 6px; border-radius:4px; border:1px solid var(--border);">Live</span>
                    </div>
                    <div id="chat-list" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column-reverse; gap:10px;"></div>
                </div>

                <!-- Col 3: Event Log -->
                <div class="card" data-testid="card-events" style="height:100%;">
                    <div class="card-header"><span class="card-title">Event Log</span></div>
                    <div id="event-list" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px;"></div>
                </div>

            </div>
        </div>

        <!-- SETTINGS: SYSTEM -->
        <div id="view-settings-system" class="view" data-testid="view-settings-system">
            <div class="settings-grid">
                <div class="card">
                    <div class="card-header"><span class="card-title">Systemstatus</span></div>
                    <div class="card-body">
                        <div class="form-row"><label>Laufzeit</label> <span id="sys-uptime">0s</span></div>
                        <div class="form-row"><label>Geladene Addons</label> <span id="sys-addons">0</span></div>
                        <div class="form-row"><label>App-Version</label> <span>1.0.0</span></div>
                    </div>
                </div>
                <div class="card" style="border-color: var(--danger);">
                    <div class="card-header"><span class="card-title" style="color:var(--danger);">Gefahrenzone</span></div>
                    <div class="card-body">
                        <p style="font-size:0.8rem; color:var(--muted);">Alle gesammelten Punkte und Benutzerdaten zur√ºcksetzen.</p>
                        <button class="btn-danger" onclick="openResetModal()" data-testid="btn-reset-stats">Alle Statistiken zur√ºcksetzen</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS: POINTS & LEVELS -->
        <div id="view-settings-points" class="view" data-testid="view-settings-points">
            <div class="settings-grid">
                <div class="card">
                    <div class="card-header"><span class="card-title">Punktesystem</span></div>
                    <div class="card-body">
                        <div class="form-row"><label>W√§hrungsname</label> <input type="text" data-bind="points.name" data-testid="input-points-name"></div>
                        <hr style="border:0; border-top:1px solid var(--border);">
                        <div class="form-row"><label>Punkte pro Coin</label> <input type="number" data-bind="points.coin"></div>
                        <div class="form-row"><label>Punkte pro Share</label> <input type="number" data-bind="points.share"></div>
                        <div class="form-row"><label>Punkte pro Chat</label> <input type="number" data-bind="points.chat"></div>
                        <div class="form-row"><label>Sub Bonus (%)</label> <input type="number" data-bind="points.subBonus"></div>
                        <div class="form-row"><label>Zielwert (Goal)</label> <input type="number" data-bind="points.goalTarget"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Level</span></div>
                    <div class="card-body">
                        <div class="form-row"><label>Basis Punkte</label> <input type="number" data-bind="levels.points"></div>
                        <div class="form-row"><label>Multiplikator</label> <input type="number" step="0.1" data-bind="levels.multiplier"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS: BROADCAST -->
        <div id="view-settings-broadcast" class="view" data-testid="view-settings-broadcast">
             <div class="settings-grid">
                <!-- OBS -->
                <div class="card">
                    <div class="card-header"><span class="card-title">OBS Integration</span></div>
                    <div class="card-body">
                        <details>
                            <summary>Verbindungseinstellungen</summary>
                            <div class="details-content">
                                <div class="form-row"><label>IP Adresse</label> <input type="text" data-bind="obs.ip"></div>
                                <div class="form-row"><label>Port</label> <input type="number" data-bind="obs.port"></div>
                                <div class="form-row"><label>Passwort</label> <input type="password" data-bind="obs.password"></div>
                                <button class="btn-secondary" onclick="testIntegration('obs')">Verbinden / Testen</button>
                            </div>
                        </details>

                        <div style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
                            <label>Szene Wechseln</label>
                            <div style="display:flex; gap:5px;">
                                <select id="obs-scenes-list"><option>-- W√§hle --</option></select>
                                <button class="btn-secondary" onclick="obsSwitchScene()">Go</button>
                            </div>
                            <button class="btn-icon" style="margin-top:5px; width:100%;" onclick="obsLoadScenes()">Szenen laden</button>
                        </div>

                        <div style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
                            <label>Source Toggle (Sichtbarkeit)</label>
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="obs-source-name" placeholder="Quellenname">
                                <button class="btn-secondary" onclick="obsToggleSource()">Toggle</button>
                            </div>
                        </div>

                        <!-- NEW OBS CONTROLS -->
                         <div style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
                            <label>Audio & Stream</label>
                            <div style="display:flex; gap:5px; margin-bottom:5px;">
                                <input type="text" id="obs-audio-source" placeholder="Audio Quelle">
                                <button class="btn-secondary" onclick="obsToggleMute()">Mute/Unmute</button>
                            </div>
                            <div style="display:flex; gap:5px;">
                                <button class="btn-primary" onclick="obsStream(true)">Stream Start</button>
                                <button class="btn-danger" onclick="obsStream(false)">Stream Stop</button>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Streamer.bot -->
                <div class="card">
                    <div class="card-header"><span class="card-title">Streamer.bot Integration</span></div>
                    <div class="card-body">
                         <details>
                            <summary>Verbindungseinstellungen</summary>
                            <div class="details-content">
                                <div class="form-row"><label>Adresse</label> <input type="text" data-bind="streamerbot.address"></div>
                                <div class="form-row"><label>Port</label> <input type="number" data-bind="streamerbot.port"></div>
                                <div class="form-row"><label>Endpoint</label> <input type="text" data-bind="streamerbot.endpoint"></div>
                                <div class="form-row"><label>Passwort</label> <input type="password" data-bind="streamerbot.password" placeholder="Optional"></div>
                                <button class="btn-secondary" onclick="testIntegration('streamerbot')">Verbinden / Testen</button>
                            </div>
                        </details>

                        <div style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
                            <label>Aktionen (DoAction)</label>
                            <div style="display:flex; gap:5px;">
                                <select id="sb-actions-list"><option>-- W√§hle --</option></select>
                                <button class="btn-secondary" onclick="sbDoAction()">Starten</button>
                            </div>
                            <button class="btn-icon" style="margin-top:5px; width:100%;" onclick="sbLoadActions()">Aktionen laden</button>
                        </div>
                    </div>
                </div>
             </div>
        </div>

        <!-- SETTINGS: CHAT -->
        <div id="view-settings-chat" class="view" data-testid="view-settings-chat">
             <div class="settings-grid">
                <!-- Session Management -->
                <div class="card">
                    <div class="card-header"><span class="card-title">TikTok Session / Chat senden</span></div>
                    <div class="card-body">
                        <label>Session Modus</label>
                        <select id="session-mode" onchange="updateSessionUI()">
                            <option value="none">Keine Session</option>
                            <option value="manual">Manuell eingeben</option>
                            <option value="webview">Login im Webviewer (Beta)</option>
                        </select>

                        <div id="session-manual-ui" style="display:none; margin-top:10px;">
                            <label>Session ID (Aus Browser-Cookies)</label>
                            <input type="password" id="session-id-input" placeholder="Paste sessionid cookie value here">
                            <div style="font-size:0.75rem; color:var(--muted); margin-top:5px;">
                                <strong>Anleitung:</strong> 1. TikTok im Browser √∂ffnen. 2. DevTools (F12) > Application > Cookies. 3. Wert von 'sessionid' kopieren.
                            </div>
                        </div>

                        <div id="session-status" style="margin-top:15px; padding:10px; background:rgba(255,255,255,0.05); border-radius:6px; font-size:0.85rem;">
                            Session Status: <span id="lbl-session-active">Unbekannt</span>
                        </div>

                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="btn-primary" onclick="saveSession()">Session Speichern</button>
                            <button class="btn-danger" onclick="clearSession()">L√∂schen</button>
                        </div>

                        <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">

                        <div class="form-row">
                            <input type="text" id="chat-test-msg" placeholder="Testnachricht senden...">
                            <button class="btn-secondary" onclick="sendTestChat()">Senden</button>
                        </div>
                    </div>
                </div>

             </div>
        </div>

        <!-- SETTINGS: COMMANDS -->
        <div id="view-settings-commands" class="view" data-testid="view-settings-commands">
             <div class="settings-grid">
                <div class="card">
                    <div class="card-header"><span class="card-title">Integrierte Befehle</span></div>
                    <div class="card-body">
                        <div class="check-group"><input type="checkbox" data-bind="commands.builtIn.help.enabled"> <span>!help</span></div>
                        <div class="check-group"><input type="checkbox" data-bind="commands.builtIn.score.enabled"> <span>!score</span></div>
                        <div class="check-group"><input type="checkbox" data-bind="commands.builtIn.send.enabled"> <span>!send (Punkte transfer)</span></div>
                        <div class="check-group"><input type="checkbox" data-bind="commands.builtIn.spin.enabled"> <span>!spin (Gl√ºcksrad)</span></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Befehlslisten</span></div>
                    <div class="card-body">
                        <div class="check-group"><input type="checkbox" data-bind="commands.listing.commands.enabled"> <span>!commands (Global)</span></div>
                        <div class="check-group"><input type="checkbox" data-bind="commands.listing.subcommands.enabled"> <span>!subcommands (Abonnenten)</span></div>
                    </div>
                </div>
             </div>
        </div>

        <!-- SETTINGS: TTS -->
        <div id="view-settings-tts" class="view" data-testid="view-settings-tts">
            <!-- Summary Bar -->
            <div class="summary-bar">
                <div class="sum-item"><span class="sum-label">TTS Engine</span><span class="sum-val" id="sum-tts">Aus</span></div>
                <div style="width:1px; height:20px; background:var(--border);"></div>
                <div class="sum-item"><span class="sum-label">Ausl√∂ser</span><span class="sum-val" id="sum-trigger">Jeder</span></div>
            </div>

            <div class="settings-grid">
                <!-- General Settings -->
                <div class="card">
                    <div class="card-header"><span class="card-title">Allgemein</span></div>
                    <div class="card-body">
                        <div class="check-group" style="background:rgba(255,255,255,0.03); padding:10px; border-radius:6px; border:1px solid var(--border);">
                            <input type="checkbox" data-bind="tts.enabled" id="tts-enabled" data-testid="check-tts-enabled"> <span style="font-weight:600;">TTS System aktivieren</span>
                        </div>
                        <div class="form-row"><label>Sprache</label><select data-bind="tts.language"><option value="de-DE">Deutsch (DE)</option><option value="en-US">English (US)</option></select></div>
                        <div class="form-row"><label>Stimme</label><select data-bind="tts.voice"><option value="default">System Standard</option></select></div>
                        <div class="form-row"><label>Lautst√§rke</label><input type="range" data-bind="tts.volume" min="0" max="1" step="0.1"></div>
                        <details style="margin-top:10px;">
                            <summary>Feinabstimmung</summary>
                            <div class="details-content">
                                <div class="form-row"><label>Geschwindigkeit</label><input type="range" data-bind="tts.speed" min="0.5" max="2" step="0.1"></div>
                                <div class="form-row"><label>Tonh√∂he</label><input type="range" data-bind="tts.pitch" min="0.5" max="2" step="0.1"></div>
                                <div class="check-group"><input type="checkbox" data-bind="tts.randomVoice"> <span>Zuf√§llige Stimme pro User</span></div>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- Permissions -->
                <div class="card">
                    <div class="card-header"><span class="card-title">Berechtigungen & Ausl√∂ser</span></div>
                    <div class="card-body">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div class="check-group"><input type="checkbox" data-bind="tts.allowed.all"> <strong>Alle User</strong></div>
                            <div class="check-group"><input type="checkbox" data-bind="tts.allowed.follower"> <span>Follower</span></div>
                            <div class="check-group"><input type="checkbox" data-bind="tts.allowed.sub"> <span>Subs</span></div>
                            <div class="check-group"><input type="checkbox" data-bind="tts.allowed.mod"> <span>Mods</span></div>
                            <div class="check-group"><input type="checkbox" data-bind="tts.allowed.team"> <span>Team</span></div>
                            <div class="check-group"><input type="checkbox" data-bind="tts.allowed.topGifters"> <span>Top Gifter</span></div>
                        </div>
                        <hr style="border:0; border-top:1px solid var(--border); width:100%; margin:15px 0;">
                        <label>Ausl√∂ser Methode</label>
                        <select data-bind="tts.trigger">
                            <option value="any">Jeder Kommentar</option>
                            <option value="dot">Startet mit Punkt (.)</option>
                            <option value="slash">Startet mit Slash (/)</option>
                            <option value="command">Bestimmter Befehl</option>
                        </select>
                        <input type="text" data-bind="tts.command" placeholder="!tts" style="margin-top:5px;">
                    </div>
                </div>

                <!-- Tester -->
                <div class="card">
                    <div class="card-header"><span class="card-title">Tester</span></div>
                    <div class="card-body">
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="test-text" placeholder="Hallo Welt" value="Hallo Welt">
                            <button class="btn-primary" onclick="testVoice()">‚ñ∂</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS: GIFTS -->
        <div id="view-settings-gifts" class="view" data-testid="view-settings-gifts">
            <div class="card">
                <div class="card-body" style="align-items: center; padding: 40px;">
                    <h3>Geschenke Verwaltung</h3>
                    <p style="color:var(--muted); text-align:center; max-width:400px; margin-bottom:20px;">
                        Gespeicherte Geschenke ansehen, Assets laden und Darstellung konfigurieren.
                    </p>
                    <button class="btn-primary" onclick="openGiftBrowser()" data-testid="btn-open-gift-browser">Geschenke Browser √∂ffnen</button>
                    <div style="margin-top:20px;">
                        <div class="check-group"><input type="checkbox" data-bind="gifts.blackWhiteDefault"> <span>S/W als Standard nutzen</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: OVERLAYS -->
        <div id="view-overlays" class="view" data-testid="view-overlays">
            <div class="settings-grid">
                <div class="card">
                    <div class="card-header"><span class="card-title">OBS Link</span></div>
                    <div class="card-body">
                        <p style="font-size:0.8rem; color:var(--muted);">F√ºge diesen Link als Browser Source in OBS ein:</p>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="obs-link" readonly value="http://localhost:5175/overlay/main">
                            <button class="btn-secondary" onclick="navigator.clipboard.writeText(document.getElementById('obs-link').value)">Kopieren</button>
                        </div>
                        <div style="font-size:0.75rem; color:#4ade80; margin-top:10px;">‚óè Folgt der aktiven Szene</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Aktive Szene</span></div>
                    <div class="card-body">
                        <select id="active-scene-select" onchange="changeActiveScene(this.value)">
                            <option value="default">Standard Szene</option>
                        </select>
                        <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:5px; margin-top:15px;" id="quick-scene-btns">
                            <!-- JS populated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: OVERLAY COMPOSER -->
        <div id="view-overlay-composer" class="view" style="display:none; flex-direction: column; height: 100vh; overflow:hidden;" data-testid="view-overlay-composer">
            <div style="display:flex; height:100%;">
                <!-- Left: Scenes & Widgets -->
                <div style="width: 320px; min-width: 300px; background: var(--panel); border-right: 1px solid var(--border); display:flex; flex-direction:column; resize:horizontal; overflow:auto;">
                    <div style="padding:10px; border-bottom:1px solid var(--border); font-weight:600;">Szenen</div>
                    <div id="composer-scene-list" style="flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:5px; min-height: 200px;"></div>
                    <button class="btn-secondary" style="margin:10px;" onclick="addScene()">+ Neue Szene</button>

                    <div style="padding:10px; border-top:1px solid var(--border); border-bottom:1px solid var(--border); font-weight:600;">Widgets</div>
                    <div id="composer-widget-lib" style="flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:5px;"></div>
                </div>

                <!-- Center: Stage -->
                <div style="flex:1; background:#000; display:flex; flex-direction:column;">
                    <div style="padding:10px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between;">
                        <span id="composer-current-scene-name" style="font-weight:bold;">Szene</span>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-primary" onclick="saveSettings()">Speichern</button>
                        </div>
                    </div>
                    <div class="stage-container" id="stage-container">
                        <div class="stage-wrapper" id="stage-wrapper">
                             <div class="stage" id="stage"></div>
                        </div>
                    </div>
                </div>

                <!-- Right: Properties -->
                <div style="width: 250px; background: var(--panel); border-left: 1px solid var(--border); display:flex; flex-direction:column;">
                     <div style="padding:10px; border-bottom:1px solid var(--border); font-weight:600;">Eigenschaften</div>
                     <div id="composer-props" style="padding:15px; display:flex; flex-direction:column; gap:10px;">
                         <div style="color:var(--muted); font-size:0.8rem; text-align:center;">Kein Widget ausgew√§hlt</div>
                     </div>
                </div>
            </div>
        </div>

        <!-- MCP VIEW -->
        <div id="view-mcp" class="view hidden" data-testid="view-mcp">
          <div class="view-header" style="margin-bottom:20px;">
            <h2>MCP - Master Control Program</h2>
          </div>

          <div class="dashboard-grid">
             <!-- Card 1: Status -->
             <div class="card">
                 <div class="card-header"><span class="card-title">Status</span></div>
                 <div class="card-body">
                     <div id="mcp-status-display" class="status-indicator">
                         <span class="status-dot"></span> <span class="status-text">Laden...</span>
                     </div>
                     <div class="status-details" id="mcp-status-details"></div>
                     <div class="btn-group">
                         <button id="mcp-start-btn" class="btn-primary">Start</button>
                         <button id="mcp-stop-btn" class="btn-danger">Stop</button>
                     </div>
                 </div>
             </div>

             <!-- Card 2: Auth -->
             <div class="card">
                 <div class="card-header"><span class="card-title">Verbindung & Auth</span></div>
                 <div class="card-body">
                     <p class="description">OAuth 2.0 Integration & Credentials</p>

                     <div style="background:rgba(255,255,255,0.03); padding:10px; border-radius:6px; margin-bottom:10px;">
                         <div class="form-row"><label>Public URL</label> <input type="text" id="mcp-public-url" readonly></div>
                         <div class="form-row"><label>Client ID</label> <input type="text" id="mcp-client-id" readonly></div>
                         <div class="form-row"><label>Client Secret</label>
                             <div style="display:flex; gap:5px; width:100%;">
                                 <input type="text" id="mcp-client-secret" readonly value="********">
                                 <button class="btn-icon" onclick="copySecret()">üìã</button>
                             </div>
                         </div>
                         <button class="btn-secondary" style="margin-top:5px; width:100%;" onclick="generateCredentials()">Neu Generieren</button>
                     </div>

                     <button id="mcp-auth-test-btn" class="btn-secondary">Auth Endpoints Testen</button>
                     <div id="mcp-auth-result" class="log-output small" style="margin-top:10px;"></div>
                 </div>
             </div>

             <!-- Card 3: Policies -->
             <div class="card">
                 <div class="card-header"><span class="card-title">Rollen & Policies</span></div>
                 <div class="card-body">
                     <ul class="policy-list">
                         <li><strong>addon_dev:</strong> addons/**, public/**</li>
                         <li><strong>core_fix:</strong> src/**, public/**</li>
                         <li><strong>config_mgr:</strong> data/config.json</li>
                     </ul>
                 </div>
             </div>

             <!-- Card 4: Taskboard -->
             <div class="card full-width">
                 <div class="card-header">
                     <span class="card-title">Taskboard</span>
                     <button class="btn-secondary" onclick="createTask()">+ Task</button>
                 </div>
                 <div class="card-body">
                     <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; min-height:200px;">
                         <div class="task-col" data-status="backlog">
                             <div class="col-head">Backlog</div>
                             <div class="task-list" id="task-list-backlog"></div>
                         </div>
                         <div class="task-col" data-status="in_progress">
                             <div class="col-head">In Arbeit</div>
                             <div class="task-list" id="task-list-in_progress"></div>
                         </div>
                         <div class="task-col" data-status="done">
                             <div class="col-head">Erledigt</div>
                             <div class="task-list" id="task-list-done"></div>
                         </div>
                     </div>
                 </div>
             </div>

             <!-- Card 5: DIV Queue -->
             <div class="card full-width">
                 <div class="card-header"><span class="card-title">DIV Queue (√Ñnderungspakete)</span></div>
                 <div class="card-body">
                     <div style="display:flex; gap:10px; margin-bottom:10px;">
                         <button class="btn-secondary" onclick="filterDivs('all')">Alle</button>
                         <button class="btn-secondary" onclick="filterDivs('draft')">Draft</button>
                         <button class="btn-secondary" onclick="filterDivs('review')">Review</button>
                         <button class="btn-secondary" onclick="filterDivs('applied')">Applied</button>
                     </div>
                     <div id="mcp-div-list" class="item-list">
                         <p class="empty-state">Lade Pakete...</p>
                     </div>
                 </div>
             </div>

             <!-- Card 6: Artefakte (Screenshots) -->
             <div class="card full-width">
                 <div class="card-header"><span class="card-title">Artefakte & Screenshots</span></div>
                 <div class="card-body">
                     <div id="mcp-artifacts-list" style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px;">
                         <p class="empty-state">Lade Artefakte...</p>
                     </div>
                 </div>
             </div>

             <!-- Card 7: Logs -->
             <div class="card full-width">
                 <div class="card-header"><span class="card-title">Logs</span></div>
                 <div class="card-body">
                    <div id="mcp-logs" class="log-output" style="height: 200px;"></div>
                 </div>
             </div>
          </div>
        </div>

        <!-- USER DB -->
        <div id="view-users" class="view" data-testid="view-users">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">User Datenbank</span>
                    <div class="card-chips">
                        <button class="btn-icon" onclick="loadUsers(userPage-1)">‚óÄ</button>
                        <span id="user-page-lbl" style="padding:0 10px; font-size:0.8rem;">1</span>
                        <button class="btn-icon" onclick="loadUsers(userPage+1)">‚ñ∂</button>
                    </div>
                </div>
                <div class="card-body" style="padding:0;">
                    <table id="user-table">
                        <thead><tr><th>User</th><th>Punkte</th><th>Diamanten</th><th>Aktionen</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL: RESET -->
    <div id="modal-reset" class="modal-overlay" data-testid="modal-reset">
        <div class="modal" style="width:400px;">
            <div class="modal-header" style="color:var(--danger);">‚ö† Reset Best√§tigen</div>
            <div class="modal-body">
                <p>Dies l√∂scht ALLE Benutzerpunkte und Statistiken. Das kann nicht r√ºckg√§ngig gemacht werden.</p>
                <p>Tippe <strong>RESET</strong> zum Best√§tigen:</p>
                <input type="text" id="reset-confirm-input" onkeyup="checkResetBtn()" data-testid="input-reset-confirm">
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('modal-reset').classList.remove('active')">Abbrechen</button>
                <button class="btn-danger" id="btn-do-reset" disabled onclick="doReset()" data-testid="btn-do-reset">Jetzt zur√ºcksetzen</button>
            </div>
        </div>
    </div>

    <!-- MODAL: GIFTS -->
    <div id="modal-gifts" class="modal-overlay" data-testid="modal-gifts">
        <div class="modal" style="width:800px; height:80vh;">
            <div class="modal-header">
                <span>Geschenke Browser</span>
                <button class="btn-icon" onclick="document.getElementById('modal-gifts').classList.remove('active')">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="gift-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap:10px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary">Auswahl herunterladen (Stub)</button>
            </div>
        </div>
    </div>

    <!-- MODAL: CONNECT -->
    <div id="modal-connect" class="modal-overlay" data-testid="modal-connect">
        <div class="modal" style="width:500px;">
             <div class="modal-header">
                <span>Mit TikTok Verbinden</span>
                <button class="btn-icon" onclick="document.getElementById('modal-connect').classList.remove('active')">‚úï</button>
            </div>
            <div class="modal-body">
                <label>TikTok Username</label>
                <input type="text" id="conn-user-modal" placeholder="@username" style="font-size:1.1rem; padding:10px;">
                <p style="font-size:0.8rem; color:var(--muted); margin-top:10px;">
                    Der Server verbindet sich mit dem Live-Chat dieses Users. Der Stream muss live sein.
                </p>
                <hr>
                <p style="text-align:center; font-size:0.8rem; color:var(--muted);">oder</p>
                <button class="btn-secondary" style="width:100%;" onclick="showView('mcp'); document.getElementById('modal-connect').classList.remove('active');">MCP Workshop √∂ffnen</button>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('modal-connect').classList.remove('active')">Abbrechen</button>
                <button class="btn-primary" onclick="connectSystemModal()">Verbinden</button>
            </div>
        </div>
    </div>

    <script src="js/app.js"></script>
</body>
</html>
