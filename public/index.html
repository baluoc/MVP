<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TK Event Zentrale</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f111a; --panel: #1a1d29; --primary: #ff0050; --accent: #00f2ea; --text: #fff; --muted: #8a8d98; --border: #2f3342; --success: #4ade80; --danger: #ef4444; --warning: #eab308; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Layout & Scrollbars */
        .sidebar { width: 240px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; overflow-y: auto; }
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: var(--bg); } ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* Navigation */
        .brand { font-size: 1.2rem; font-weight: 800; margin-bottom: 30px; color: var(--text); display: flex; align-items: center; gap: 8px; }
        .brand span { color: var(--primary); background: rgba(255,0,80,0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }

        .nav-group { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 15px; margin-bottom: 5px; font-weight: 700; }
        .nav-item { padding: 10px 12px; margin-bottom: 2px; border-radius: 6px; cursor: pointer; color: var(--muted); transition: 0.2s; display: flex; align-items: center; gap: 10px; font-weight: 500; font-size: 0.9rem; }
        .nav-item:hover { background: rgba(255, 255, 255, 0.03); color: var(--text); }
        .nav-item.active { background: rgba(255, 0, 80, 0.1); color: var(--primary); }
        .nav-sub { padding-left: 34px; font-size: 0.85rem; }

        /* Views */
        .view { display: none; padding: 25px; height: 100%; overflow-y: auto; box-sizing: border-box; }
        .view.active { display: block; animation: fadeIn 0.2s ease; }
        #view-overlay-composer.view.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Rich Dashboard Grid */
        .dashboard-grid {
             display: grid;
             grid-template-columns: 360px 1fr 300px; /* Preview | Chat | Log */
             grid-template-rows: auto 1fr;
             gap: 20px;
             height: 100%;
             padding-bottom: 20px;
        }

        /* Preview Stage - WIREFRAME / HEX PATTERN */
        .stage-container-preview {
            width: 100%;
            aspect-ratio: 9/16;
            background-color: #050505;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px, 30px 30px;
            border: 8px solid #222; /* Phone Frame */
            border-radius: 24px;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.9), 0 10px 30px rgba(0,0,0,0.5);
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .stage-iframe {
            border: none;
            width: 1080px;
            height: 1920px;
            transform-origin: center;
            /* Scale will be set by JS */
        }
        .stage-overlay-label {
            position: absolute;
            top: 20px;
            left: 50%; transform: translateX(-50%);
            background: var(--primary);
            color: white;
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .stage-overlay-label.bottom {
            top: auto; bottom: 20px;
            background: rgba(0,0,0,0.8);
            color: #888;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Mock Bubble - Fixed Bottom Style */
        .mock-bubble {
            position: absolute;
            bottom: 60px; left: 20px; right: 20px;
            background: rgba(0,0,0,0.85);
            padding: 12px; border-radius: 12px;
            color: white; font-size: 0.9rem;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.15);
            pointer-events: none;
            display: flex; flex-direction: column; gap: 4px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .mock-bubble strong { color: var(--warning); font-weight: 700; }

        /* Pulsing Live Badge */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 80, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 80, 0); } }
        .live-badge {
            background: var(--primary); color: white;
            font-size: 0.7rem; padding: 4px 8px; border-radius: 4px;
            font-weight: 700; display: inline-flex; align-items: center; gap: 6px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .live-badge.active { animation: pulse-red 2s infinite; }
        .live-badge.inactive { background: #333; color: #888; animation: none; }


        /* Event Log Cards */
        .log-entry {
             background: var(--panel);
             border: 1px solid var(--border);
             border-left: 4px solid var(--muted);
             border-radius: 8px;
             padding: 12px;
             margin-bottom: 8px;
             font-size: 0.85rem;
             display: flex;
             gap: 12px;
             align-items: center;
             box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .log-entry.gift { border-left-color: var(--primary); }
        .log-entry.sub { border-left-color: var(--warning); }
        .log-entry.chat { border-left-color: var(--accent); }

        .log-icon { width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
        .log-content { flex: 1; min-width: 0; }
        .log-title { font-weight: 600; color: var(--text); margin-bottom: 2px; }
        .log-desc { color: var(--muted); font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .log-time { font-size: 0.65rem; color: #555; align-self: flex-start; }

        /* Chat Specific */
        .chat-bubble {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            display: flex; gap: 10px;
        }
        .chat-avatar { width: 28px; height: 28px; border-radius: 50%; background: #333; flex-shrink: 0; }
        .chat-name { font-weight: 700; margin-right: 5px; font-size: 0.8rem; }
        .chat-text { color: #ddd; word-break: break-word; line-height: 1.4; }


        /* --- CARDS & GRID --- */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; padding-bottom: 50px; }
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: border-color 0.2s; position: relative; }
        .card:hover { border-color: rgba(255,255,255,0.1); }

        .card-header { padding: 12px 15px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; height: 40px; }
        .card-title { font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; }
        .card-body { padding: 15px; display: flex; flex-direction: column; gap: 15px; flex: 1; }
        .card-footer { padding: 10px 15px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.1); display: flex; justify-content: flex-end; gap: 10px; font-size: 0.8rem; }
        .card-chips { display: flex; gap: 5px; }

        /* Form Elements */
        label { font-size: 0.8rem; color: var(--muted); font-weight: 500; margin-bottom: 4px; display: block; }
        .form-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 5px; }
        .form-row label { margin-bottom: 0; }

        input[type="text"], input[type="number"], input[type="password"], select {
            background: var(--bg); border: 1px solid var(--border); color: white; padding: 6px 10px; border-radius: 4px; font-size: 0.85rem; width: 100%; box-sizing: border-box; transition: 0.2s;
        }
        input:disabled, select:disabled { opacity: 0.5; cursor: not-allowed; }
        input:focus, select:focus { outline: none; border-color: var(--primary); }

        /* Custom Toggle */
        .check-group { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.85rem; }
        .check-group input { accent-color: var(--primary); }

        /* Button */
        .btn-primary { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
        .btn-danger { background: var(--danger); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid var(--border); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
        .btn-icon { background: transparent; color: var(--muted); border: 1px solid var(--border); padding: 4px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { color: var(--text); border-color: var(--text); }

        /* Details / Accordion */
        details { border: 1px solid var(--border); border-radius: 6px; overflow: hidden; background: rgba(0,0,0,0.1); }
        details summary { padding: 10px; cursor: pointer; font-weight: 600; font-size: 0.85rem; background: rgba(255,255,255,0.02); display: flex; align-items: center; justify-content: space-between; }
        details[open] summary { border-bottom: 1px solid var(--border); }
        .details-content { padding: 15px; display: flex; flex-direction: column; gap: 15px; }

        /* Header Summary Bar */
        .summary-bar { display: flex; gap: 15px; align-items: center; font-size: 0.8rem; color: var(--muted); margin-bottom: 20px; background: var(--panel); padding: 8px 15px; border-radius: 8px; border: 1px solid var(--border); }
        .sum-item { display: flex; flex-direction: column; line-height: 1.1; }
        .sum-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7; }
        .sum-val { color: var(--text); font-weight: 600; }
        .sum-val.on { color: var(--success); }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; width: 600px; max-width: 90vw; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: rgba(0,0,0,0.1); }

        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; color: var(--muted); font-weight: 500; border-bottom: 1px solid var(--border); padding: 5px; font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 8px 5px; border-bottom: 1px solid #222; }

        /* COMPOSER */
        .stage-container { background: #000; width: 100%; height: 500px; position: relative; overflow: hidden; border: 1px solid var(--border); border-radius: 8px; display: flex; justify-content: center; align-items: center; }
        .stage-wrapper { transform-origin: center; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .stage { width: 1080px; height: 1920px; background: #111; position: relative; overflow: hidden; }
        .stage-widget { position: absolute; border: 2px solid rgba(255,255,255,0.2); box-sizing: border-box; cursor: grab; background: rgba(255,0,80,0.1); color: white; display: flex; justify-content: center; align-items: center; user-select: none; }
        .stage-widget:hover, .stage-widget.selected { border-color: var(--primary); z-index: 10; }
        .stage-widget .handle { width: 10px; height: 10px; background: white; position: absolute; bottom: -5px; right: -5px; cursor: nwse-resize; display: none; }
        .stage-widget.selected .handle { display: block; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand"><span>TK</span> EVENT SERVER</div>

        <div class="nav-group">Monitoring</div>
        <div class="nav-item active" onclick="showView('dashboard')" data-view="dashboard" data-testid="nav-dashboard">üìä Live √úbersicht</div>
        <div class="nav-item" onclick="showView('users')" data-view="users" data-testid="nav-users">üìà Statistiken / DB</div>

        <div class="nav-group">Konfiguration</div>
        <div class="nav-item nav-sub" onclick="showView('settings-system')" data-view="settings-system" data-testid="nav-system">System</div>
        <div class="nav-item nav-sub" onclick="showView('settings-points')" data-view="settings-points" data-testid="nav-points">Punkte & Level</div>
        <div class="nav-item nav-sub" onclick="showView('settings-broadcast')" data-view="settings-broadcast" data-testid="nav-broadcast">Broadcast</div>
        <div class="nav-item nav-sub" onclick="showView('settings-chat')" data-view="settings-chat" data-testid="nav-chat">Chat</div>
        <div class="nav-item nav-sub" onclick="showView('settings-commands')" data-view="settings-commands" data-testid="nav-commands">Befehle</div>
        <div class="nav-item nav-sub" onclick="showView('settings-tts')" data-view="settings-tts" data-testid="nav-tts">TTS</div>
        <div class="nav-item nav-sub" onclick="showView('settings-gifts')" data-view="settings-gifts" data-testid="nav-gifts">Geschenke / Assets</div>

        <div class="nav-group">Overlay</div>
        <div class="nav-item nav-sub" onclick="showView('overlays')" data-view="overlays" data-testid="nav-overlays">Overlays</div>
        <div class="nav-item nav-sub" onclick="showView('overlay-composer')" data-view="overlay-composer" data-testid="nav-composer">Overlay-Composer</div>


        <div style="margin-top: auto; padding-top:20px; border-top:1px solid var(--border);">
            <div style="font-size: 0.75rem; color: var(--muted); margin-bottom: 5px;">VERBINDUNG</div>
            <div style="display:flex; align-items:center; gap:8px;">
                <div id="status-dot" style="width: 8px; height: 8px; background: #666; border-radius: 50%;"></div>
                <span id="status-text" style="font-size: 0.85rem; color: #999;" data-testid="status-text">Offline</span>
            </div>
            <div id="status-meta" style="font-size: 0.7rem; color: var(--muted); margin-top: 4px;"></div>
        </div>
    </div>

    <div class="main">
        <!-- Top Bar -->
        <div style="height: 50px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: var(--bg);">
            <div style="display:flex; align-items:center; gap:15px;">
                <div style="font-weight: 600; font-size: 0.9rem;" id="page-title" data-testid="page-title">Live √úbersicht</div>
                <div id="live-badge" class="live-badge inactive" data-testid="live-badge">OFFLINE</div>
            </div>

            <div style="display:flex; gap:10px; align-items: center;">
                <button class="btn-primary" id="btn-save" onclick="saveSettings()" style="display:none;" data-testid="btn-save">√Ñnderungen speichern</button>

                <!-- Connection UI now simplified or in modal? Let's keep a compact version here for usability -->
                <div id="connect-ui-compact" style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:0.8rem; color:var(--muted); text-align:right; line-height:1.1;">
                        Verbindungs-User<br><strong id="top-conn-user" style="color:var(--text); cursor:pointer;" onclick="openConnectModal()">@Nicht Verbunden</strong>
                    </span>
                    <button class="btn-icon" onclick="openConnectModal()">‚öôÔ∏è</button>
                </div>
            </div>
        </div>

        <!-- DASHBOARD (Rich UI) -->
        <div id="view-dashboard" class="view active" data-testid="view-dashboard" style="overflow:hidden;">
            <div class="dashboard-grid">

                <!-- Col 1: Live Vorschau -->
                <div style="display:flex; flex-direction:column; gap:15px;">
                    <div class="stage-container-preview" id="preview-container">
                        <div class="stage-overlay-label">TIKTOK OUTPUT</div>
                        <iframe id="preview-frame" class="stage-iframe" src="about:blank"></iframe>
                        <div class="stage-overlay-label bottom">LIVE FEED (1080x1920)</div>
                        <!-- Mock Overlay Bubble -->
                        <div class="mock-bubble" id="mock-preview-bubble">
                            <strong>@user123</strong>
                            <span>Das ist eine Vorschau des Overlays.</span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><span class="card-title">LIVE METRIKEN</span></div>
                        <div class="card-body" style="flex-direction:row; justify-content:space-around;">
                            <div style="text-align:center;">
                                <div style="font-size:0.75rem; color:var(--muted); text-transform:uppercase;">Zuschauer</div>
                                <div style="font-size:1.5rem; font-weight:bold; color:var(--text);" id="metric-viewers">0</div>
                            </div>
                            <div style="text-align:center;">
                                <div style="font-size:0.75rem; color:var(--muted); text-transform:uppercase;">Likes</div>
                                <div style="font-size:1.5rem; font-weight:bold; color:var(--primary);">0</div> <!-- Stub for Likes -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Col 2: Live Chat -->
                <div class="card" data-testid="card-chat-stream" style="height:100%;">
                    <div class="card-header">
                        <span class="card-title">Live Chat</span>
                        <span style="background:var(--panel); font-size:0.7rem; padding:2px 6px; border-radius:4px; border:1px solid var(--border);">Live</span>
                    </div>
                    <div id="chat-list" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column-reverse; gap:10px;"></div>
                </div>

                <!-- Col 3: Event Log -->
                <div class="card" data-testid="card-events" style="height:100%;">
                    <div class="card-header"><span class="card-title">Event Log</span></div>
                    <div id="event-list" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px;"></div>
                </div>

            </div>
        </div>

        <!-- SETTINGS: SYSTEM -->
        <div id="view-settings-system" class="view" data-testid="view-settings-system">
            <div class="settings-grid">
                <div class="card">
                    <div class="card-header"><span class="card-title">Systemstatus</span></div>
                    <div class="card-body">
                        <div class="form-row"><label>Laufzeit</label> <span id="sys-uptime">0s</span></div>
                        <div class="form-row"><label>Geladene Addons</label> <span id="sys-addons">0</span></div>
                        <div class="form-row"><label>App-Version</label> <span>1.0.0</span></div>
                    </div>
                </div>
                <div class="card" style="border-color: var(--danger);">
                    <div class="card-header"><span class="card-title" style="color:var(--danger);">Gefahrenzone</span></div>
                    <div class="card-body">
                        <p style="font-size:0.8rem; color:var(--muted);">Alle gesammelten Punkte und Benutzerdaten zur√ºcksetzen.</p>
                        <button class="btn-danger" onclick="openResetModal()" data-testid="btn-reset-stats">Alle Statistiken zur√ºcksetzen</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS: POINTS & LEVELS -->
        <div id="view-settings-points" class="view" data-testid="view-settings-points">
            <div class="settings-grid">
                <div class="card">
                    <div class="card-header"><span class="card-title">Punktesystem</span></div>
                    <div class="card-body">
                        <div class="form-row"><label>W√§hrungsname</label> <input type="text" data-bind="points.name" data-testid="input-points-name"></div>
                        <hr style="border:0; border-top:1px solid var(--border);">
                        <div class="form-row"><label>Punkte pro Coin</label> <input type="number" data-bind="points.coin"></div>
                        <div class="form-row"><label>Punkte pro Share</label> <input type="number" data-bind="points.share"></div>
                        <div class="form-row"><label>Punkte pro Chat</label> <input type="number" data-bind="points.chat"></div>
                        <div class="form-row"><label>Sub Bonus (%)</label> <input type="number" data-bind="points.subBonus"></div>
                        <div class="form-row"><label>Zielwert (Goal)</label> <input type="number" data-bind="points.goalTarget"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Level</span></div>
                    <div class="card-body">
                        <div class="form-row"><label>Basis Punkte</label> <input type="number" data-bind="levels.points"></div>
                        <div class="form-row"><label>Multiplikator</label> <input type="number" step="0.1" data-bind="levels.multiplier"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS: BROADCAST -->
        <div id="view-settings-broadcast" class="view" data-testid="view-settings-broadcast">
             <div class="settings-grid">
                <!-- OBS -->
                <div class="card">
                    <div class="card-header"><span class="card-title">OBS Integration</span></div>
                    <div class="card-body">
                        <details>
                            <summary>Verbindungseinstellungen</summary>
                            <div class="details-content">
                                <div class="form-row"><label>IP Adresse</label> <input type="text" data-bind="obs.ip"></div>
                                <div class="form-row"><label>Port</label> <input type="number" data-bind="obs.port"></div>
                                <div class="form-row"><label>Passwort</label> <input type="password" data-bind="obs.password"></div>
                                <button class="btn-secondary" onclick="testIntegration('obs')">Verbinden / Testen</button>
                            </div>
                        </details>

                        <div style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
                            <label>Szene Wechseln</label>
                            <div style="display:flex; gap:5px;">
                                <select id="obs-scenes-list"><option>-- W√§hle --</option></select>
                                <button class="btn-secondary" onclick="obsSwitchScene()">Go</button>
                            </div>
                            <button class="btn-icon" style="margin-top:5px; width:100%;" onclick="obsLoadScenes()">Szenen laden</button>
                        </div>

                        <div style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
                            <label>Source Toggle (Sichtbarkeit)</label>
                            <div style="display:flex; gap:5px;">
                                <input type="text" id="obs-source-name" placeholder="Quellenname">
                                <button class="btn-secondary" onclick="obsToggleSource()">Toggle</button>
                            </div>
                        </div>

                        <!-- NEW OBS CONTROLS -->
                         <div style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
                            <label>Audio & Stream</label>
                            <div style="display:flex; gap:5px; margin-bottom:5px;">
                                <input type="text" id="obs-audio-source" placeholder="Audio Quelle">
                                <button class="btn-secondary" onclick="obsToggleMute()">Mute/Unmute</button>
                            </div>
                            <div style="display:flex; gap:5px;">
                                <button class="btn-primary" onclick="obsStream(true)">Stream Start</button>
                                <button class="btn-danger" onclick="obsStream(false)">Stream Stop</button>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Streamer.bot -->
                <div class="card">
                    <div class="card-header"><span class="card-title">Streamer.bot Integration</span></div>
                    <div class="card-body">
                         <details>
                            <summary>Verbindungseinstellungen</summary>
                            <div class="details-content">
                                <div class="form-row"><label>Adresse</label> <input type="text" data-bind="streamerbot.address"></div>
                                <div class="form-row"><label>Port</label> <input type="number" data-bind="streamerbot.port"></div>
                                <div class="form-row"><label>Endpoint</label> <input type="text" data-bind="streamerbot.endpoint"></div>
                                <div class="form-row"><label>Passwort</label> <input type="password" data-bind="streamerbot.password" placeholder="Optional"></div>
                                <button class="btn-secondary" onclick="testIntegration('streamerbot')">Verbinden / Testen</button>
                            </div>
                        </details>

                        <div style="margin-top:15px; border-top:1px solid var(--border); padding-top:10px;">
                            <label>Aktionen (DoAction)</label>
                            <div style="display:flex; gap:5px;">
                                <select id="sb-actions-list"><option>-- W√§hle --</option></select>
                                <button class="btn-secondary" onclick="sbDoAction()">Starten</button>
                            </div>
                            <button class="btn-icon" style="margin-top:5px; width:100%;" onclick="sbLoadActions()">Aktionen laden</button>
                        </div>
                    </div>
                </div>
             </div>
        </div>

        <!-- SETTINGS: CHAT -->
        <div id="view-settings-chat" class="view" data-testid="view-settings-chat">
             <div class="settings-grid">
                <!-- Session Management -->
                <div class="card">
                    <div class="card-header"><span class="card-title">TikTok Session / Chat senden</span></div>
                    <div class="card-body">
                        <label>Session Modus</label>
                        <select id="session-mode" onchange="updateSessionUI()">
                            <option value="none">Keine Session</option>
                            <option value="manual">Manuell eingeben</option>
                            <option value="webview">Login im Webviewer (Beta)</option>
                        </select>

                        <div id="session-manual-ui" style="display:none; margin-top:10px;">
                            <label>Session ID (Aus Browser-Cookies)</label>
                            <input type="password" id="session-id-input" placeholder="Paste sessionid cookie value here">
                            <div style="font-size:0.75rem; color:var(--muted); margin-top:5px;">
                                <strong>Anleitung:</strong> 1. TikTok im Browser √∂ffnen. 2. DevTools (F12) > Application > Cookies. 3. Wert von 'sessionid' kopieren.
                            </div>
                        </div>

                        <div id="session-status" style="margin-top:15px; padding:10px; background:rgba(255,255,255,0.05); border-radius:6px; font-size:0.85rem;">
                            Session Status: <span id="lbl-session-active">Unbekannt</span>
                        </div>

                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="btn-primary" onclick="saveSession()">Session Speichern</button>
                            <button class="btn-danger" onclick="clearSession()">L√∂schen</button>
                        </div>

                        <hr style="border:0; border-top:1px solid var(--border); margin:15px 0;">

                        <div class="form-row">
                            <input type="text" id="chat-test-msg" placeholder="Testnachricht senden...">
                            <button class="btn-secondary" onclick="sendTestChat()">Senden</button>
                        </div>
                    </div>
                </div>

             </div>
        </div>

        <!-- SETTINGS: COMMANDS -->
        <div id="view-settings-commands" class="view" data-testid="view-settings-commands">
             <div class="settings-grid">
                <div class="card">
                    <div class="card-header"><span class="card-title">Integrierte Befehle</span></div>
                    <div class="card-body">
                        <div class="check-group"><input type="checkbox" data-bind="commands.builtIn.help.enabled"> <span>!help</span></div>
                        <div class="check-group"><input type="checkbox" data-bind="commands.builtIn.score.enabled"> <span>!score</span></div>
                        <div class="check-group"><input type="checkbox" data-bind="commands.builtIn.send.enabled"> <span>!send (Punkte transfer)</span></div>
                        <div class="check-group"><input type="checkbox" data-bind="commands.builtIn.spin.enabled"> <span>!spin (Gl√ºcksrad)</span></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Befehlslisten</span></div>
                    <div class="card-body">
                        <div class="check-group"><input type="checkbox" data-bind="commands.listing.commands.enabled"> <span>!commands (Global)</span></div>
                        <div class="check-group"><input type="checkbox" data-bind="commands.listing.subcommands.enabled"> <span>!subcommands (Abonnenten)</span></div>
                    </div>
                </div>
             </div>
        </div>

        <!-- SETTINGS: TTS -->
        <div id="view-settings-tts" class="view" data-testid="view-settings-tts">
            <!-- Summary Bar -->
            <div class="summary-bar">
                <div class="sum-item"><span class="sum-label">TTS Engine</span><span class="sum-val" id="sum-tts">Aus</span></div>
                <div style="width:1px; height:20px; background:var(--border);"></div>
                <div class="sum-item"><span class="sum-label">Ausl√∂ser</span><span class="sum-val" id="sum-trigger">Jeder</span></div>
            </div>

            <div class="settings-grid">
                <!-- General Settings -->
                <div class="card">
                    <div class="card-header"><span class="card-title">Allgemein</span></div>
                    <div class="card-body">
                        <div class="check-group" style="background:rgba(255,255,255,0.03); padding:10px; border-radius:6px; border:1px solid var(--border);">
                            <input type="checkbox" data-bind="tts.enabled" id="tts-enabled" data-testid="check-tts-enabled"> <span style="font-weight:600;">TTS System aktivieren</span>
                        </div>
                        <div class="form-row"><label>Sprache</label><select data-bind="tts.language"><option value="de-DE">Deutsch (DE)</option><option value="en-US">English (US)</option></select></div>
                        <div class="form-row"><label>Stimme</label><select data-bind="tts.voice"><option value="default">System Standard</option></select></div>
                        <div class="form-row"><label>Lautst√§rke</label><input type="range" data-bind="tts.volume" min="0" max="1" step="0.1"></div>
                        <details style="margin-top:10px;">
                            <summary>Feinabstimmung</summary>
                            <div class="details-content">
                                <div class="form-row"><label>Geschwindigkeit</label><input type="range" data-bind="tts.speed" min="0.5" max="2" step="0.1"></div>
                                <div class="form-row"><label>Tonh√∂he</label><input type="range" data-bind="tts.pitch" min="0.5" max="2" step="0.1"></div>
                                <div class="check-group"><input type="checkbox" data-bind="tts.randomVoice"> <span>Zuf√§llige Stimme pro User</span></div>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- Permissions -->
                <div class="card">
                    <div class="card-header"><span class="card-title">Berechtigungen & Ausl√∂ser</span></div>
                    <div class="card-body">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div class="check-group"><input type="checkbox" data-bind="tts.allowed.all"> <strong>Alle User</strong></div>
                            <div class="check-group"><input type="checkbox" data-bind="tts.allowed.follower"> <span>Follower</span></div>
                            <div class="check-group"><input type="checkbox" data-bind="tts.allowed.sub"> <span>Subs</span></div>
                            <div class="check-group"><input type="checkbox" data-bind="tts.allowed.mod"> <span>Mods</span></div>
                            <div class="check-group"><input type="checkbox" data-bind="tts.allowed.team"> <span>Team</span></div>
                            <div class="check-group"><input type="checkbox" data-bind="tts.allowed.topGifters"> <span>Top Gifter</span></div>
                        </div>
                        <hr style="border:0; border-top:1px solid var(--border); width:100%; margin:15px 0;">
                        <label>Ausl√∂ser Methode</label>
                        <select data-bind="tts.trigger">
                            <option value="any">Jeder Kommentar</option>
                            <option value="dot">Startet mit Punkt (.)</option>
                            <option value="slash">Startet mit Slash (/)</option>
                            <option value="command">Bestimmter Befehl</option>
                        </select>
                        <input type="text" data-bind="tts.command" placeholder="!tts" style="margin-top:5px;">
                    </div>
                </div>

                <!-- Tester -->
                <div class="card">
                    <div class="card-header"><span class="card-title">Tester</span></div>
                    <div class="card-body">
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="test-text" placeholder="Hallo Welt" value="Hallo Welt">
                            <button class="btn-primary" onclick="testVoice()">‚ñ∂</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS: GIFTS -->
        <div id="view-settings-gifts" class="view" data-testid="view-settings-gifts">
            <div class="card">
                <div class="card-body" style="align-items: center; padding: 40px;">
                    <h3>Geschenke Verwaltung</h3>
                    <p style="color:var(--muted); text-align:center; max-width:400px; margin-bottom:20px;">
                        Gespeicherte Geschenke ansehen, Assets laden und Darstellung konfigurieren.
                    </p>
                    <button class="btn-primary" onclick="openGiftBrowser()" data-testid="btn-open-gift-browser">Geschenke Browser √∂ffnen</button>
                    <div style="margin-top:20px;">
                        <div class="check-group"><input type="checkbox" data-bind="gifts.blackWhiteDefault"> <span>S/W als Standard nutzen</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: OVERLAYS -->
        <div id="view-overlays" class="view" data-testid="view-overlays">
            <div class="settings-grid">
                <div class="card">
                    <div class="card-header"><span class="card-title">OBS Link</span></div>
                    <div class="card-body">
                        <p style="font-size:0.8rem; color:var(--muted);">F√ºge diesen Link als Browser Source in OBS ein:</p>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="obs-link" readonly value="http://localhost:5175/overlay/main">
                            <button class="btn-secondary" onclick="navigator.clipboard.writeText(document.getElementById('obs-link').value)">Kopieren</button>
                        </div>
                        <div style="font-size:0.75rem; color:#4ade80; margin-top:10px;">‚óè Folgt der aktiven Szene</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title">Aktive Szene</span></div>
                    <div class="card-body">
                        <select id="active-scene-select" onchange="changeActiveScene(this.value)">
                            <option value="default">Standard Szene</option>
                        </select>
                        <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:5px; margin-top:15px;" id="quick-scene-btns">
                            <!-- JS populated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: OVERLAY COMPOSER -->
        <div id="view-overlay-composer" class="view" style="display:none; flex-direction: column; height: 100vh; overflow:hidden;" data-testid="view-overlay-composer">
            <div style="display:flex; height:100%;">
                <!-- Left: Scenes & Widgets -->
                <div style="width: 320px; min-width: 300px; background: var(--panel); border-right: 1px solid var(--border); display:flex; flex-direction:column; resize:horizontal; overflow:auto;">
                    <div style="padding:10px; border-bottom:1px solid var(--border); font-weight:600;">Szenen</div>
                    <div id="composer-scene-list" style="flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:5px; min-height: 200px;"></div>
                    <button class="btn-secondary" style="margin:10px;" onclick="addScene()">+ Neue Szene</button>

                    <div style="padding:10px; border-top:1px solid var(--border); border-bottom:1px solid var(--border); font-weight:600;">Widgets</div>
                    <div id="composer-widget-lib" style="flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:5px;"></div>
                </div>

                <!-- Center: Stage -->
                <div style="flex:1; background:#000; display:flex; flex-direction:column;">
                    <div style="padding:10px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between;">
                        <span id="composer-current-scene-name" style="font-weight:bold;">Szene</span>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-primary" onclick="saveSettings()">Speichern</button>
                        </div>
                    </div>
                    <div class="stage-container" id="stage-container">
                        <div class="stage-wrapper" id="stage-wrapper">
                             <div class="stage" id="stage"></div>
                        </div>
                    </div>
                </div>

                <!-- Right: Properties -->
                <div style="width: 250px; background: var(--panel); border-left: 1px solid var(--border); display:flex; flex-direction:column;">
                     <div style="padding:10px; border-bottom:1px solid var(--border); font-weight:600;">Eigenschaften</div>
                     <div id="composer-props" style="padding:15px; display:flex; flex-direction:column; gap:10px;">
                         <div style="color:var(--muted); font-size:0.8rem; text-align:center;">Kein Widget ausgew√§hlt</div>
                     </div>
                </div>
            </div>
        </div>


        <!-- USER DB -->
        <div id="view-users" class="view" data-testid="view-users">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">User Datenbank</span>
                    <div class="card-chips">
                        <button class="btn-icon" onclick="loadUsers(userPage-1)">‚óÄ</button>
                        <span id="user-page-lbl" style="padding:0 10px; font-size:0.8rem;">1</span>
                        <button class="btn-icon" onclick="loadUsers(userPage+1)">‚ñ∂</button>
                    </div>
                </div>
                <div class="card-body" style="padding:0;">
                    <table id="user-table">
                        <thead><tr><th>User</th><th>Punkte</th><th>Diamanten</th><th>Aktionen</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- MODAL: RESET -->
    <div id="modal-reset" class="modal-overlay" data-testid="modal-reset">
        <div class="modal" style="width:400px;">
            <div class="modal-header" style="color:var(--danger);">‚ö† Reset Best√§tigen</div>
            <div class="modal-body">
                <p>Dies l√∂scht ALLE Benutzerpunkte und Statistiken. Das kann nicht r√ºckg√§ngig gemacht werden.</p>
                <p>Tippe <strong>RESET</strong> zum Best√§tigen:</p>
                <input type="text" id="reset-confirm-input" onkeyup="checkResetBtn()" data-testid="input-reset-confirm">
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('modal-reset').classList.remove('active')">Abbrechen</button>
                <button class="btn-danger" id="btn-do-reset" disabled onclick="doReset()" data-testid="btn-do-reset">Jetzt zur√ºcksetzen</button>
            </div>
        </div>
    </div>

    <!-- MODAL: GIFTS -->
    <div id="modal-gifts" class="modal-overlay" data-testid="modal-gifts">
        <div class="modal" style="width:800px; height:80vh;">
            <div class="modal-header">
                <span>Geschenke Browser</span>
                <button class="btn-icon" onclick="document.getElementById('modal-gifts').classList.remove('active')">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="gift-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap:10px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary">Auswahl herunterladen (Stub)</button>
            </div>
        </div>
    </div>

    <!-- MODAL: CONNECT -->
    <div id="modal-connect" class="modal-overlay" data-testid="modal-connect">
        <div class="modal" style="width:500px;">
             <div class="modal-header">
                <span>Mit TikTok Verbinden</span>
                <button class="btn-icon" onclick="document.getElementById('modal-connect').classList.remove('active')">‚úï</button>
            </div>
            <div class="modal-body">
                <label>TikTok Username</label>
                <input type="text" id="conn-user-modal" placeholder="@username" style="font-size:1.1rem; padding:10px;">
                <p style="font-size:0.8rem; color:var(--muted); margin-top:10px;">
                    Der Server verbindet sich mit dem Live-Chat dieses Users. Der Stream muss live sein.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="document.getElementById('modal-connect').classList.remove('active')">Abbrechen</button>
                <button class="btn-primary" onclick="connectSystemModal()">Verbinden</button>
            </div>
        </div>
    </div>

    <script>
        let scratchConfig = {};
        let currentView = 'dashboard';
        let userPage = 1;
        let isConnected = false;

        // Composer State
        let selectedSceneId = null;
        let selectedWidgetId = null;
        let availableWidgets = [];

        const VIEW_TITLES = {
            "dashboard": "Live √úbersicht",
            "settings-system": "Einstellungen: System",
            "settings-points": "Einstellungen: Punkte & Level",
            "settings-broadcast": "Einstellungen: Broadcast",
            "settings-chat": "Einstellungen: Chat",
            "settings-commands": "Einstellungen: Befehle",
            "settings-tts": "Einstellungen: TTS",
            "settings-gifts": "Einstellungen: Geschenke",
            "overlays": "Overlays",
            "overlay-composer": "Overlay-Composer",
            "users": "User DB"
        };

        // --- CORE NAVIGATION ---
        function showView(id) {
            // 1. Reset all Views and Navs
            document.querySelectorAll('.view').forEach(el => {
                el.classList.remove('active');
                el.style.display = '';
            });
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

            // 2. Activate Target View
            const view = document.getElementById('view-' + id);
            if (view) {
                view.classList.add('active');
            }

            // 3. Highlight Target Nav (Strict Match)
            const activeNav = document.querySelector(`.nav-item[data-view='${id}']`);
            if (activeNav) {
                activeNav.classList.add('active');
            } else {
                console.warn("No nav item found for view:", id);
            }

            // Guard: Assert single active nav
            const actives = document.querySelectorAll('.nav-item.active');
            if(actives.length > 1) {
                console.warn("FIX: Multiple active navs found. Cleaning up...");
                actives.forEach(el => {
                    if(el !== activeNav) el.classList.remove('active');
                });
            }

            currentView = id;
            // Strict German Titles
            const t = VIEW_TITLES[id] || id.toUpperCase();
            document.getElementById('page-title').innerText = t;

            // Context specific actions
            document.getElementById('btn-save').style.display = id.startsWith('settings') ? 'block' : 'none';

            if(id === 'users') loadUsers(1);
            if(id === 'overlays') loadOverlaySettings();
            if(id === 'overlay-composer') initComposer();
            if(id === 'settings-broadcast') {
                 // Try to prefill lists if connected?
            }

            // If Dashboard, update iframe scale and render mock data if needed
            if(id === 'dashboard') {
                setTimeout(resizePreview, 100);
                if (!isConnected) {
                    checkMockData();
                }
            }
        }

        // --- SCRATCHPAD LOGIC ---
        // Deep set helper
        function setPath(obj, path, val) {
            const keys = path.split('.');
            let last = keys.pop();
            let target = obj;
            for(let k of keys) {
                if(!target[k]) target[k] = {};
                target = target[k];
            }
            target[last] = val;
        }

        // Deep get helper
        function getPath(obj, path) {
            return path.split('.').reduce((o, i) => o ? o[i] : undefined, obj);
        }

        async function initSettings() {
            const res = await fetch('/api/settings');
            scratchConfig = await res.json();
            renderSettings();
        }

        function renderSettings() {
            document.querySelectorAll('[data-bind]').forEach(el => {
                const path = el.getAttribute('data-bind');
                const val = getPath(scratchConfig, path);

                if(el.type === 'checkbox') el.checked = !!val;
                else el.value = (val === undefined || val === null) ? '' : val;

                // Bind Event
                el.onchange = (e) => {
                    const newVal = el.type === 'checkbox' ? el.checked :
                                   (el.type === 'number' || el.type === 'range') ? Number(el.value) : el.value;
                    setPath(scratchConfig, path, newVal);
                    updateUIState(); // Refresh calculated UI
                };
            });
            updateUIState();
        }

        async function saveSettings() {
            await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(scratchConfig)
            });
            alert("Konfiguration gespeichert!");
        }

        // --- SESSION LOGIC ---
        async function loadSession() {
            const res = await fetch('/api/tiktok/session');
            const data = await res.json();

            document.getElementById('session-mode').value = data.mode;
            document.getElementById('lbl-session-active').innerText = data.hasSessionId
                ? `Gesetzt (Aktualisiert: ${new Date(data.updatedAt).toLocaleString()})`
                : "Nicht gesetzt";
            document.getElementById('lbl-session-active').style.color = data.hasSessionId ? "var(--success)" : "var(--muted)";

            updateSessionUI();
        }

        function updateSessionUI() {
            const mode = document.getElementById('session-mode').value;
            document.getElementById('session-manual-ui').style.display = (mode === 'manual') ? 'block' : 'none';
        }

        async function saveSession() {
            const mode = document.getElementById('session-mode').value;
            const sessionId = document.getElementById('session-id-input').value;

            const payload = { mode };
            if(mode === 'manual' && sessionId) {
                payload.sessionId = sessionId;
            }

            const res = await fetch('/api/tiktok/session', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if(res.ok) {
                alert("Session gespeichert!");
                document.getElementById('session-id-input').value = ""; // clear for security
                loadSession();
            } else {
                alert("Fehler beim Speichern");
            }
        }

        async function clearSession() {
            if(!confirm("Session wirklich l√∂schen?")) return;
            await fetch('/api/tiktok/session/clear', { method: 'POST' });
            loadSession();
            alert("Session gel√∂scht.");
        }

        async function sendTestChat() {
            const txt = document.getElementById('chat-test-msg').value;
            if(!txt) return;

            const res = await fetch('/api/chat/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ text: txt })
            });
            const data = await res.json();

            if(data.ok) {
                alert("Nachricht gesendet!");
            } else {
                alert(`Fehler: ${data.reason} (Mode: ${data.mode})`);
            }
        }

        function updateUIState() {
            // Visual Updates (Chips, Summaries) derived from scratchConfig
            const tts = scratchConfig.tts || {};
            document.getElementById('sum-tts').innerText = tts.enabled ? "An" : "Aus";
            document.getElementById('sum-tts').className = tts.enabled ? "sum-val on" : "sum-val";
            document.getElementById('sum-trigger').innerText = (tts.trigger || "any").toUpperCase();
        }

        // --- FEATURES & INTEGRATIONS ---

        // Integrations Tester (OBS, Streamerbot)
        async function testIntegration(service) {
            const res = await fetch(`/api/${service}/test`, { method: 'POST' });
            const data = await res.json();
            if(data.ok) {
                alert(`${service} verbunden! Status: ` + JSON.stringify(data.info));
            } else {
                alert(`Test fehlgeschlagen: ${data.reason}`);
            }
        }

        // OBS Functions
        async function obsLoadScenes() {
            const res = await fetch('/api/obs/action', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ type: 'getScenes' })
            });
            const data = await res.json();
            if(data.ok && data.scenes) {
                const sel = document.getElementById('obs-scenes-list');
                sel.innerHTML = "";
                data.scenes.forEach(s => {
                    const opt = document.createElement("option");
                    opt.value = s.sceneName;
                    opt.innerText = s.sceneName;
                    sel.appendChild(opt);
                });
            } else {
                alert("Konnte Szenen nicht laden: " + (data.reason || 'Unbekannt'));
            }
        }

        async function obsSwitchScene() {
            const s = document.getElementById('obs-scenes-list').value;
            if(!s) return;
            await fetch('/api/obs/action', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ type: 'switchScene', data: { sceneName: s } })
            });
        }

        async function obsToggleSource() {
            const name = document.getElementById('obs-source-name').value;
            if(!name) return;
            const enabled = confirm("Soll die Quelle '" + name + "' aktiviert werden? (Cancel=Deaktivieren)");
            await fetch('/api/obs/action', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ type: 'toggleInput', data: { inputName: name, enabled: enabled } })
            });
        }

        async function obsToggleMute() {
            const name = document.getElementById('obs-audio-source').value;
            if(!name) return;
            await fetch('/api/obs/action', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ type: 'toggleMute', data: { inputName: name } })
            });
            alert("Mute toggled for " + name);
        }

        async function obsStream(start) {
             const type = start ? 'startStream' : 'stopStream';
             await fetch('/api/obs/action', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ type: type })
            });
            alert(start ? "Stream gestartet" : "Stream gestoppt");
        }


        // Streamer.bot Functions
        async function sbLoadActions() {
            const res = await fetch('/api/streamerbot/actions');
            const actions = await res.json();
            const sel = document.getElementById('sb-actions-list');
            sel.innerHTML = "";
            actions.forEach(a => {
                const opt = document.createElement("option");
                opt.value = a.id;
                opt.innerText = a.name;
                sel.appendChild(opt);
            });
            if(actions.length === 0) alert("Keine Actions gefunden oder nicht verbunden.");
        }

        async function sbDoAction() {
            const id = document.getElementById('sb-actions-list').value;
            if(!id) return;
            await fetch('/api/streamerbot/action', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ actionId: id })
            });
            alert("Action ausgef√ºhrt");
        }


        // Danger Zone
        function openResetModal() {
            document.getElementById('reset-confirm-input').value = "";
            document.getElementById('btn-do-reset').disabled = true;
            document.getElementById('modal-reset').classList.add('active');
        }

        function checkResetBtn() {
            const val = document.getElementById('reset-confirm-input').value;
            document.getElementById('btn-do-reset').disabled = (val !== 'RESET');
        }

        async function doReset() {
            await fetch('/api/reset-stats', { method: 'POST' });
            document.getElementById('modal-reset').classList.remove('active');
            alert("Statistiken zur√ºckgesetzt.");
        }

        // Gifts
        async function openGiftBrowser() {
            document.getElementById('modal-gifts').classList.add('active');
            const res = await fetch('/api/gifts');
            const gifts = await res.json();
            const grid = document.getElementById('gift-grid');
            grid.innerHTML = "";

            if(gifts.length === 0) {
                grid.innerHTML = "<div style='grid-column:1/-1; text-align:center; color:gray;'>Noch keine Geschenke im Cache. Verbinde mit TikTok und warte auf Geschenke!</div>";
                return;
            }

            gifts.forEach(g => {
                const div = document.createElement('div');
                div.style.background = "rgba(0,0,0,0.3)";
                div.style.padding = "10px";
                div.style.borderRadius = "8px";
                div.style.textAlign = "center";
                div.innerHTML = `
                    <img src="${g.iconUrl}" style="width:40px; height:40px;">
                    <div style="font-size:0.7rem; margin-top:5px; overflow:hidden; text-overflow:ellipsis;">${g.name}</div>
                    <div style="font-size:0.65rem; color:#ffd700;">üíé ${g.cost}</div>
                `;
                grid.appendChild(div);
            });
        }

        // Users
        async function loadUsers(p) {
            if(p < 1) return;
            userPage = p;
            document.getElementById('user-page-lbl').innerText = p;

            const res = await fetch(`/api/users?page=${p}&limit=20&sort=score`);
            const data = await res.json();
            const tbody = document.querySelector('#user-table tbody');
            tbody.innerHTML = "";

            data.users.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="display:flex; align-items:center; gap:8px;">
                        <img src="${u.profilePictureUrl || ''}" style="width:24px; height:24px; border-radius:50%; background:#333;">
                        ${u.nickname || u.uniqueId}
                    </td>
                    <td><b>${u.points}</b></td>
                    <td>${u.diamondCount}</td>
                    <td>
                        <button class="btn-icon" onclick="adjustPoints('${u.key}', 100)">+100</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function adjustPoints(id, delta) {
            // Quick stub logic
            await fetch(`/api/users/${encodeURIComponent(id)}/adjust`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ delta })
            });
            loadUsers(userPage);
        }

        // Connection Modal & Logic
        function openConnectModal() {
             document.getElementById('modal-connect').classList.add('active');
        }

        async function connectSystemModal() {
            const u = document.getElementById('conn-user-modal').value;
            if(!u) return;
            await fetch('/api/connect', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ uniqueId: u }) });
            document.getElementById('modal-connect').classList.remove('active');
        }

        async function checkStatus() {
            const res = await fetch('/api/status');
            const s = await res.json();
            document.getElementById('sys-uptime').innerText = Math.floor(s.uptime) + "s";
            document.getElementById('sys-addons').innerText = s.addonsLoaded;

            if(s.connected) {
                isConnected = true;
                document.getElementById('status-text').innerText = `Online: @${s.uniqueId}`;
                document.getElementById('status-dot').style.background = "#4ade80";

                // Top Bar Update
                document.getElementById('top-conn-user').innerText = "@" + s.uniqueId;
                const b = document.getElementById('live-badge');
                b.className = "live-badge active";
                b.innerText = "‚óè LIVE STREAM AKTIV";
                b.style.opacity = "1";

                if(s.roomInfo) {
                    document.getElementById('status-meta').innerText = `Zuschauer: ${s.roomInfo.roomUserCount || 0}`;
                }
                clearMockData();
            } else {
                isConnected = false;
                document.getElementById('status-text').innerText = "Offline";
                document.getElementById('status-dot').style.background = "#666";
                document.getElementById('top-conn-user').innerText = "@Nicht Verbunden";
                const b = document.getElementById('live-badge');
                b.className = "live-badge active";

                // DEMO MODE VISUALS
                // User wants "LIVE STREAM AKTIV" look even in Demo/Offline if we want to show it populated.
                // We use a slight distinction: "LIVE STREAM (DEMO)" but with red pulse
                b.innerText = "‚óè LIVE STREAM (DEMO)";
                b.style.opacity = "0.7";

                // Show mock data if viewing dashboard and list is empty
                if (currentView === 'dashboard') checkMockData();
            }
        }
        setInterval(checkStatus, 3000);

        // --- Mock Data Logic ---
        function checkMockData() {
            const chatList = document.getElementById('chat-list');
            const eventList = document.getElementById('event-list');

            if (chatList.children.length === 0) {
                renderMockChat();
            }
            if (eventList.children.length === 0) {
                renderMockEvents();
            }
        }

        function clearMockData() {
            // Remove elements with class 'mock-item'
            document.querySelectorAll('.mock-item').forEach(el => el.remove());
        }

        function renderMockChat() {
            const list = document.getElementById('chat-list');
            const items = [
                { name: 'UserA', text: 'Hallo, das ist ein Test!', sub: false },
                { name: 'Subscriber', text: 'Cooles Dashboard Design!', sub: true }
            ];
            items.forEach(i => {
                const d = document.createElement('div');
                d.className = "chat-bubble mock-item";
                d.innerHTML = `
                    <div class="chat-avatar"></div>
                    <div>
                        <span class="chat-name" style="color:${i.sub ? 'var(--warning)' : 'var(--text)'};">${i.name}:</span>
                        <span class="chat-text">${i.text}</span>
                    </div>
                `;
                list.appendChild(d); // Reverse column-reverse
            });
        }

        function renderMockEvents() {
            const list = document.getElementById('event-list');

            const e1 = document.createElement('div');
            e1.className = "log-entry gift mock-item";
            e1.innerHTML = `
                <div class="log-icon" style="border:1px solid var(--primary);">üéÅ</div>
                <div class="log-content">
                    <div class="log-title">Gifter_One</div>
                    <div class="log-desc">sendet 10x Rose</div>
                </div>
                <div class="log-time">12:00</div>
            `;

            const e2 = document.createElement('div');
            e2.className = "log-entry sub mock-item";
            e2.innerHTML = `
                <div class="log-icon">‚≠ê</div>
                <div class="log-content">
                    <div class="log-title">New Subscriber</div>
                    <div class="log-desc">hat abonniert</div>
                </div>
                <div class="log-time">12:01</div>
            `;

            const e3 = document.createElement('div');
            e3.className = "log-entry chat mock-item";
            e3.innerHTML = `
                <div class="log-icon">üí¨</div>
                <div class="log-content">
                    <div class="log-title">Chatter</div>
                    <div class="log-desc">Hat einen Befehl genutzt</div>
                </div>
                <div class="log-time">12:02</div>
            `;

            list.appendChild(e1);
            list.appendChild(e2);
            list.appendChild(e3);
        }


        // TTS Test
        function testVoice() {
             const text = document.getElementById('test-text').value;
             const msg = new SpeechSynthesisUtterance(text);
             msg.lang = scratchConfig.tts.language;
             msg.volume = scratchConfig.tts.volume;
             msg.rate = scratchConfig.tts.speed;
             msg.pitch = scratchConfig.tts.pitch;
             window.speechSynthesis.speak(msg);
        }

        // --- OVERLAY SETTINGS ---
        function loadOverlaySettings() {
             if (!scratchConfig || !scratchConfig.overlay) {
                 // Not loaded yet? Should not happen with new bootstrap
                 return;
             }
             const sel = document.getElementById('active-scene-select');
             sel.innerHTML = "";
             const scenes = scratchConfig.overlay?.scenes || [];

             if (scenes.length === 0) {
                 const opt = document.createElement("option");
                 opt.innerText = "Keine Szenen vorhanden";
                 sel.appendChild(opt);
             } else {
                 scenes.forEach(s => {
                     const opt = document.createElement("option");
                     opt.value = s.id;
                     opt.innerText = s.name || s.id || "(Unbenannt)";
                     sel.appendChild(opt);
                 });
             }
             sel.value = scratchConfig.overlay?.activeSceneId;

             // Quick buttons
             const btns = document.getElementById('quick-scene-btns');
             btns.innerHTML = "";
             scenes.slice(0, 10).forEach((s, idx) => {
                 const container = document.createElement("div");
                 container.style.display = "flex";
                 container.style.flexDirection = "column";
                 container.style.gap = "4px";

                 const btn = document.createElement("button");
                 btn.className = "btn-secondary";
                 btn.innerText = (idx+1) + ". " + (s.name || "(Unbenannt)");
                 btn.onclick = () => changeActiveScene(s.id);

                 const linkWrap = document.createElement("div");
                 linkWrap.style.display = "flex";
                 linkWrap.style.gap = "2px";

                 const linkBtn = document.createElement("button");
                 linkBtn.className = "btn-icon";
                 linkBtn.style.fontSize = "0.7rem";
                 linkBtn.innerText = "üîó";
                 linkBtn.title = "Link zur Szene kopieren";
                 linkBtn.onclick = () => {
                     const url = `${location.protocol}//${location.host}/overlay/main?scene=${s.id}`;
                     navigator.clipboard.writeText(url);
                     alert("Link kopiert: " + url);
                 };

                 linkWrap.appendChild(linkBtn);
                 container.appendChild(btn);
                 container.appendChild(linkWrap);
                 btns.appendChild(container);
             });
        }

        async function changeActiveScene(id) {
            scratchConfig.overlay.activeSceneId = id;
            await fetch('/api/overlay/active-scene', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sceneId: id })
            });
            document.getElementById('active-scene-select').value = id;
        }


        // --- OVERLAY COMPOSER ---
        async function initComposer() {
            // Load Widgets Registry
            const res = await fetch('/api/overlay/widgets');
            availableWidgets = await res.json();
            renderComposerWidgetLib();

            // Render Scene List
            renderComposerSceneList();

            // Resize Stage
            resizeComposerStage();
            window.addEventListener('resize', resizeComposerStage);

            // Select active scene by default if none selected
            if(!selectedSceneId && scratchConfig.overlay?.scenes?.length > 0) {
                selectScene(scratchConfig.overlay.scenes[0].id);
            }
        }

        function resizeComposerStage() {
            const container = document.getElementById('stage-container');
            const wrapper = document.getElementById('stage-wrapper');
            if(!container || !wrapper) return;
            const scale = Math.min((container.clientWidth - 40) / 1080, (container.clientHeight - 40) / 1920);
            wrapper.style.transform = `scale(${scale})`;
            wrapper.style.width = "1080px";
            wrapper.style.height = "1920px";
        }

        function renderComposerSceneList() {
            const list = document.getElementById('composer-scene-list');
            list.innerHTML = "";
            const scenes = scratchConfig.overlay?.scenes || [];
            scenes.forEach(s => {
                 const div = document.createElement("div");
                 div.style.padding = "8px";
                 div.style.background = (s.id === selectedSceneId) ? "rgba(255,0,80,0.2)" : "transparent";
                 div.style.border = "1px solid var(--border)";
                 div.style.borderRadius = "4px";
                 div.style.cursor = "pointer";
                 div.innerText = s.name || s.id; // Bug fix: fallback if name missing
                 div.onclick = () => selectScene(s.id);
                 list.appendChild(div);
            });
        }

        function renderComposerWidgetLib() {
            const list = document.getElementById('composer-widget-lib');
            list.innerHTML = "";
            availableWidgets.forEach(w => {
                const div = document.createElement("div");
                div.className = "chip";
                div.style.padding = "10px";
                div.style.cursor = "pointer";
                div.innerText = "+ " + w.name;
                div.onclick = () => addWidgetToScene(w);
                list.appendChild(div);
            });
        }

        function selectScene(id) {
            selectedSceneId = id;
            const s = scratchConfig.overlay.scenes.find(s=>s.id===id);
            document.getElementById('composer-current-scene-name').innerText = (s?.name || s?.id) || "Szene";
            renderComposerSceneList();
            renderStage();
            renderProps();
        }

        function addScene() {
             if(!scratchConfig.overlay.scenes) scratchConfig.overlay.scenes = [];
             const id = "scene_" + Date.now();
             scratchConfig.overlay.scenes.push({
                 id: id,
                 name: "Neue Szene",
                 width: 1080,
                 height: 1920,
                 widgets: []
             });
             selectScene(id);
        }

        function addWidgetToScene(def) {
            if(!selectedSceneId) return;
            const scene = scratchConfig.overlay.scenes.find(s=>s.id===selectedSceneId);
            const wId = "w_" + Date.now();
            scene.widgets.push({
                id: wId,
                type: def.type,
                x: 100, y: 100,
                w: def.defaultSize.w,
                h: def.defaultSize.h,
                visible: true,
                scale: 1,
                props: def.defaultProps || {}
            });
            renderStage();
        }

        function renderStage() {
            const stage = document.getElementById('stage');
            stage.innerHTML = "";
            if(!selectedSceneId) return;
            const scene = scratchConfig.overlay.scenes.find(s=>s.id===selectedSceneId);

            scene.widgets.forEach(w => {
                const el = document.createElement("div");
                el.className = "stage-widget " + (selectedWidgetId === w.id ? "selected" : "");
                el.style.left = w.x + "px";
                el.style.top = w.y + "px";
                el.style.width = w.w + "px";
                el.style.height = w.h + "px";
                el.innerText = w.type;
                el.onmousedown = (e) => startDrag(e, w.id);

                const handle = document.createElement("div");
                handle.className = "handle";
                el.appendChild(handle);

                stage.appendChild(el);
            });
        }

        // --- DRAG LOGIC (Simplified) ---
        let dragTarget = null;
        let dragStart = {x:0, y:0};
        let dragOrig = {x:0, y:0};

        function startDrag(e, wId) {
            e.stopPropagation();
            selectedWidgetId = wId;
            renderStage();
            renderProps();

            dragTarget = wId;
            dragStart = { x: e.clientX, y: e.clientY };
            const scene = scratchConfig.overlay.scenes.find(s=>s.id===selectedSceneId);
            const w = scene.widgets.find(x => x.id === wId);
            dragOrig = { x: w.x, y: w.y };

            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        function onDrag(e) {
             if(!dragTarget) return;
             // Calculate delta with scale factor
             // We need to know current scale of stage-wrapper
             // Simplification: we calculated scale in resizeComposerStage
             const container = document.getElementById('stage-container');
             const scale = Math.min((container.clientWidth - 40) / 1080, (container.clientHeight - 40) / 1920);

             const dx = (e.clientX - dragStart.x) / scale;
             const dy = (e.clientY - dragStart.y) / scale;

             const scene = scratchConfig.overlay.scenes.find(s=>s.id===selectedSceneId);
             const w = scene.widgets.find(x => x.id === dragTarget);

             w.x = Math.round(dragOrig.x + dx);
             w.y = Math.round(dragOrig.y + dy);
             renderStage();
             renderProps(); // Update inputs live
        }

        function stopDrag() {
            dragTarget = null;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
        }

        function renderProps() {
             const div = document.getElementById('composer-props');
             div.innerHTML = "";

             if(!selectedSceneId) return;

             // Scene Props
             const scene = scratchConfig.overlay.scenes.find(s=>s.id===selectedSceneId);

             div.innerHTML += `<label>Szene Name</label><input type="text" value="${scene.name}" onchange="updateSceneName(this.value)">`;
             div.innerHTML += `<hr style="width:100%; border:0; border-bottom:1px solid #333;">`;

             if(!selectedWidgetId) {
                 div.innerHTML += `<div style="color:var(--muted); font-size:0.8rem;">W√§hle ein Widget aus</div>`;
                 return;
             }

             const w = scene.widgets.find(x => x.id === selectedWidgetId);
             if(!w) return;

             div.innerHTML += `
                <div class="form-row"><label>Type</label> <span>${w.type}</span></div>
                <div class="form-row"><label>X</label> <input type="number" value="${w.x}" onchange="updateWidgetProp('x', this.value)"></div>
                <div class="form-row"><label>Y</label> <input type="number" value="${w.y}" onchange="updateWidgetProp('y', this.value)"></div>
                <div class="form-row"><label>W</label> <input type="number" value="${w.w}" onchange="updateWidgetProp('w', this.value)"></div>
                <div class="form-row"><label>H</label> <input type="number" value="${w.h}" onchange="updateWidgetProp('h', this.value)"></div>
                <div class="check-group"><input type="checkbox" ${w.visible?'checked':''} onchange="updateWidgetProp('visible', this.checked)"> <span>Sichtbar</span></div>
                <button class="btn-danger" style="margin-top:20px; width:100%;" onclick="deleteWidget()">Widget l√∂schen</button>
             `;
        }

        function updateSceneName(val) {
             const scene = scratchConfig.overlay.scenes.find(s=>s.id===selectedSceneId);
             scene.name = val;
             renderComposerSceneList();
        }

        function updateWidgetProp(prop, val) {
             const scene = scratchConfig.overlay.scenes.find(s=>s.id===selectedSceneId);
             const w = scene.widgets.find(x => x.id === selectedWidgetId);
             w[prop] = (prop==='visible') ? val : Number(val);
             renderStage();
        }

        function deleteWidget() {
             const scene = scratchConfig.overlay.scenes.find(s=>s.id===selectedSceneId);
             scene.widgets = scene.widgets.filter(x => x.id !== selectedWidgetId);
             selectedWidgetId = null;
             renderStage();
             renderProps();
        }


        // --- PREVIEW SCALING ---
        function resizePreview() {
            const container = document.getElementById('preview-container');
            const iframe = document.getElementById('preview-frame');
            if(!container || !iframe) return;

            // Container size
            const cWidth = container.clientWidth;
            const cHeight = container.clientHeight;

            // Target size (1080x1920)
            const baseW = 1080;
            const baseH = 1920;

            const scale = Math.min(cWidth / baseW, cHeight / baseH);

            iframe.style.transform = `scale(${scale})`;

            // Important: we must also force the URL if not set
            if(iframe.src === 'about:blank' || iframe.src === '') {
                 const proto = location.protocol;
                 const host = location.host;
                 iframe.src = `${proto}//${host}/overlay/main`;
            }
        }
        window.addEventListener('resize', () => {
             if(currentView === 'dashboard') resizePreview();
        });


        // --- BOOTSTRAP ---
        async function bootstrap() {
            await initSettings();
            await loadSession(); // Load session status
            showView('dashboard');
        }
        bootstrap();

        // --- WS MOCK OVERLAY (Events & Toast) ---
        const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${wsProto}://${location.host}/overlay/ws`);
        ws.onmessage = (msg) => {
            const data = JSON.parse(msg.data);
            if(data.kind === 'speak') {
                const u = new SpeechSynthesisUtterance(data.text);
                const t = scratchConfig.tts || {};
                u.lang = t.language || 'de-DE';
                u.volume = t.volume;
                u.rate = t.speed;
                u.pitch = t.pitch;
                window.speechSynthesis.speak(u);
            } else if (data.kind === 'toast' || data.kind === 'gift') {
                 // Clean up mock data if present
                 clearMockData();

                 // Event List Panel
                 const list = document.getElementById('event-list');
                 const d = document.createElement('div');
                 const isGift = data.kind === 'gift';
                 d.className = `log-entry ${isGift ? 'gift' : ''}`;

                 if(isGift) {
                     d.innerHTML = `
                        <div class="log-icon" style="border:1px solid var(--primary);"><img src="${data.giftIconUrl || 'https://via.placeholder.com/24'}" style="width:20px; height:20px;"></div>
                        <div class="log-content">
                            <div class="log-title">${data.from || 'User'}</div>
                            <div class="log-desc">sendet ${data.count}x ${data.giftName}</div>
                        </div>
                        <div class="log-time">${new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'})}</div>
                     `;
                 } else {
                     d.innerHTML = `
                        <div class="log-icon">üîî</div>
                        <div class="log-content">
                            <div class="log-title">${data.title || 'Event'}</div>
                            <div class="log-desc">${data.text}</div>
                        </div>
                        <div class="log-time">${new Date().toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'})}</div>
                     `;
                 }
                 list.prepend(d);
            } else if (data.kind === 'chat') {
                 // Clean up mock data
                 clearMockData();

                 // Chat Panel
                 const list = document.getElementById('chat-list');
                 const d = document.createElement('div');
                 d.className = "chat-bubble";
                 d.innerHTML = `
                    <img class="chat-avatar" src="${data.profilePictureUrl || ''}">
                    <div>
                        <span class="chat-name" style="color:${data.isSubscriber ? 'var(--warning)' : 'var(--text)'};">${data.nickname}:</span>
                        <span class="chat-text">${data.text}</span>
                    </div>
                 `;
                 list.prepend(d);
            } else if (data.kind === 'dashboard-update') {
                 if(document.getElementById('metric-viewers'))
                     document.getElementById('metric-viewers').innerText = data.stats?.viewers || 0;
            }
        };

    </script>
</body>
</html>
