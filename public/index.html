<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TK Event Zentrale</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f111a; --panel: #1a1d29; --primary: #ff0050; --text: #fff; --muted: #8a8d98; --border: #2f3342; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Layout */
        .sidebar { width: 240px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* Navigation */
        .brand { font-size: 1.2rem; font-weight: 800; margin-bottom: 30px; color: var(--text); }
        .brand span { color: var(--primary); }
        .nav-item { padding: 10px; margin-bottom: 5px; border-radius: 6px; cursor: pointer; color: var(--muted); transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover, .nav-item.active { background: rgba(255, 0, 80, 0.1); color: var(--primary); }

        /* Views */
        .view { display: none; padding: 20px; height: 100%; overflow-y: auto; box-sizing: border-box; }
        .view.active { display: block; }

        /* Dashboard Grid */
        .grid { display: grid; grid-template-columns: 320px 1fr 320px; gap: 20px; height: calc(100vh - 80px); }
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .panel-head { padding: 15px; border-bottom: 1px solid var(--border); font-weight: 600; display: flex; justify-content: space-between; }

        /* Preview */
        .preview-box { background: #000; flex: 1; position: relative; display: flex; justify-content: center; align-items: center; }
        .overlay-msg { position: absolute; bottom: 100px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; border: 1px solid var(--primary); display: none; }

        /* Settings Form */
        .settings-group { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .settings-group h3 { margin-top: 0; color: var(--primary); font-size: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; }
        .form-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .form-col { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 0.85rem; color: var(--muted); }
        input, select { background: var(--bg); border: 1px solid var(--border); color: white; padding: 8px; border-radius: 4px; box-sizing: border-box; width: 100%; }
        button.btn-primary { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }

        /* User Table */
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        th { color: var(--muted); font-weight: 500; }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand"><span>TK</span> ZENTRALE</div>

        <div id="nav-dashboard" class="nav-item active" onclick="showView('dashboard')">üìä Live Dashboard</div>
        <div id="nav-settings" class="nav-item" onclick="showView('settings')">‚öôÔ∏è Einstellungen</div>
        <div id="nav-users" class="nav-item" onclick="showView('users')">üë• Benutzer DB</div>

        <div style="margin-top: auto; font-size: 0.8rem; color: var(--muted);">
            Status: <span style="color: #4ade80;">‚óè Verbunden</span>
        </div>
    </div>

    <div class="main">

        <!-- Connection Bar -->
        <div style="background: var(--panel); border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; align-items: center; justify-content: space-between;">
            <div style="font-weight: 600;">System Status</div>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="text" id="conn-user" placeholder="@TikTokUser" style="background:#0f111a; border:1px solid #333; color:white; padding:6px; border-radius: 4px;">
                <button class="btn-primary" onclick="connectSystem()">Verbinden</button>
            </div>
        </div>

        <div id="view-dashboard" class="view active">
            <h2 style="margin-top: 0;">Live √úbersicht</h2>
            <div class="grid">
                <div class="panel">
                    <div class="panel-head">Live Bild (1080x1920)</div>
                    <div class="preview-box">
                        <iframe src="/overlay.html" style="width: 360px; height: 640px; border: none; transform: scale(0.85);"></iframe>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-head">Live Chat</div>
                    <div id="chat-list" style="flex: 1; overflow-y: auto; padding: 10px; font-size: 0.9rem; display: flex; flex-direction: column-reverse;"></div>
                    <div style="padding: 10px; border-top: 1px solid var(--border); display: flex;">
                        <input type="text" id="chat-input" placeholder="Nachricht senden..." style="flex: 1; margin-right: 10px;">
                        <button class="btn-primary" onclick="sendChat()">Senden</button>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-head">Ereignis-Protokoll</div>
                    <div id="event-list" style="flex: 1; overflow-y: auto; padding: 10px;"></div>
                </div>
            </div>
        </div>

        <div id="view-settings" class="view">
            <h2>System Einstellungen</h2>

            <div class="settings-group">
                <h3>üí∞ Punktesystem</h3>
                <div class="form-row">
                    <div class="form-col"><label for="conf-coin">Punkte pro M√ºnze (Geschenk)</label><input type="number" id="conf-coin"></div>
                    <div class="form-col"><label for="conf-share">Punkte pro Teilen</label><input type="number" id="conf-share"></div>
                </div>
                <div class="form-row">
                    <div class="form-col"><label for="conf-chat">Punkte pro Nachricht</label><input type="number" step="0.1" id="conf-chat"></div>
                    <div class="form-col"><label for="conf-sub">Abo-Bonus (%)</label><input type="number" id="conf-sub"></div>
                </div>
            </div>

            <div class="settings-group">
                <h3>üîä Text-zu-Sprache (TTS)</h3>
                <div class="form-row">
                    <div class="form-col">
                        <label for="conf-tts-enabled">Status</label>
                        <select id="conf-tts-enabled"><option value="true">Aktiviert</option><option value="false">Deaktiviert</option></select>
                    </div>
                    <div class="form-col">
                        <label for="conf-voice">Stimme</label>
                        <select id="conf-voice"><option value="Google Deutsch">Google Deutsch</option></select>
                    </div>
                </div>
            </div>

            <button class="btn-primary" onclick="saveSettings()">Einstellungen Speichern</button>
        </div>

        <div id="view-users" class="view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Benutzer Datenbank</h2>
                <button class="btn-primary" style="background: #ef4444;" onclick="resetStats()">‚ö†Ô∏è Alle Punkte L√∂schen</button>
            </div>
            <div class="panel">
                <table>
                    <thead><tr><th>Name</th><th>Punkte</th><th>Diamanten</th><th>Zuletzt gesehen</th></tr></thead>
                    <tbody id="user-table-body"></tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        async function connectSystem() {
            const user = document.getElementById('conn-user').value;
            if(!user) return alert("Bitte Username eingeben!");

            const res = await fetch('/api/connect', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ uniqueId: user })
            });
            const data = await res.json();
            if(data.ok) alert("Verbindung gestartet!");
            else alert("Fehler: " + data.error);
        }

        function speak(text) {
            // Pr√ºfen, ob TTS im Frontend aktiviert ist (optional, falls Backend das nicht schon filtert)
            const enabled = document.getElementById('conf-tts-enabled').value === "true";
            if (!enabled) return;

            const ut = new SpeechSynthesisUtterance(text);
            ut.lang = "de-DE";
            // Optional: Voice aus Dropdown lesen
            // const voiceName = document.getElementById('conf-voice').value;
            // ... Voice selection logic ...
            window.speechSynthesis.speak(ut);
        }

        // Navigation
        function showView(id) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            document.getElementById('nav-' + id).classList.add('active');

            if(id === 'settings') loadSettings();
            if(id === 'users') loadUsers();
        }

        // --- DASHBOARD LOGIC ---
        const chatList = document.getElementById('chat-list');
        const eventList = document.getElementById('event-list');

        // WebSocket for live updates
        const ws = new WebSocket(`ws://${location.host}/overlay/ws`);
        ws.onmessage = (msg) => {
            const data = JSON.parse(msg.data);

            if (data.kind === 'speak') {
                speak(data.text);
            }
            // Chat Toast from backend usually has kind='toast' and title='Chat ...'
            else if(data.kind === 'toast') {
                if(data.title.startsWith('Chat')) addChat(data);
                else addEvent(data);
            } else if (data.kind === 'gift') {
                addEvent(data);
            }
        };

        function addChat(data) {
            const div = document.createElement('div');
            div.style.marginBottom = "5px";
            div.innerHTML = `<strong style="color: var(--primary);">${data.title.replace('Chat ', '')}:</strong> ${data.text}`;
            chatList.prepend(div); // Newest top
        }

        function addEvent(data) {
            if(data.title === 'Like') return; // Filter spammy likes from main event list
            const div = document.createElement('div');
            div.style.padding = "10px"; div.style.background = "rgba(255,255,255,0.05)"; div.style.marginBottom = "5px"; div.style.borderRadius = "5px";
            const txt = data.text || (data.giftName ? `${data.giftName} x${data.count}` : '');
            div.innerHTML = `<strong>${data.title || data.from}</strong><br><small style="color:#ccc;">${txt}</small>`;
            eventList.prepend(div);
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            await fetch('/api/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ text: input.value }) });
            input.value = "";
        }

        // --- SETTINGS LOGIC ---
        async function loadSettings() {
            const res = await fetch('/api/settings');
            const conf = await res.json();

            // Safety check in case fields missing
            const p = conf.points || {};
            document.getElementById('conf-coin').value = p.coin || 10;
            document.getElementById('conf-share').value = p.share || 50;
            document.getElementById('conf-chat').value = p.chat || 5;
            document.getElementById('conf-sub').value = p.subBonus || 10;

            const t = conf.tts || {};
            document.getElementById('conf-tts-enabled').value = t.enabled ? "true" : "false";
        }

        async function saveSettings() {
            const body = {
                points: {
                    coin: Number(document.getElementById('conf-coin').value),
                    share: Number(document.getElementById('conf-share').value),
                    chat: Number(document.getElementById('conf-chat').value),
                    subBonus: Number(document.getElementById('conf-sub').value)
                },
                tts: {
                    enabled: document.getElementById('conf-tts-enabled').value === "true",
                    voice: document.getElementById('conf-voice').value
                }
            };
            await fetch('/api/settings', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
            alert("Gespeichert!");
        }

        // --- USER DB LOGIC ---
        async function loadUsers() {
            const res = await fetch('/api/users?limit=20');
            const data = await res.json();
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '';

            data.users.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${u.nickname || u.uniqueId}</td>
                    <td style="color: var(--primary); font-weight:bold;">${Math.floor(u.points || 0)}</td>
                    <td>${u.diamondCount}</td>
                    <td>${new Date(u.lastSeenTs).toLocaleTimeString()}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function resetStats() {
            if(confirm("Wirklich ALLE Punkte l√∂schen?")) {
                await fetch('/api/reset-stats', { method: 'POST' });
                loadUsers();
            }
        }
    </script>
</body>
</html>
