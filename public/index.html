<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TK Event Server - Dashboard</title>
    <style>
        /* --- Base & Reset --- */
        :root {
            --bg-dark: #0f111a;
            --bg-panel: #1a1d29;
            --bg-card: #23273a;
            --primary: #ff0050; /* TikTok Red */
            --accent: #00f2ea;  /* TikTok Cyan */
            --text-main: #ffffff;
            --text-dim: #8a8d98;
            --border: #2f3342;
        }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

        /* --- Sidebar --- */
        .sidebar { width: 250px; background-color: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; }
        .logo { font-size: 1.2rem; font-weight: 800; color: var(--text-main); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .logo span { color: var(--primary); }
        .menu-item { padding: 12px 15px; border-radius: 8px; color: var(--text-dim); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .menu-item:hover, .menu-item.active { background-color: #2a1a25; color: var(--primary); }
        .menu-item.active { border-left: 3px solid var(--primary); }

        /* --- Main Content --- */
        .main { flex: 1; display: flex; flex-direction: column; }

        /* Header */
        .header { height: 60px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; background-color: var(--bg-dark); }
        .status-badge { background-color: rgba(255, 0, 80, 0.2); color: var(--primary); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; border: 1px solid rgba(255, 0, 80, 0.3); }

        /* Dashboard Grid */
        .dashboard-grid { padding: 30px; display: grid; grid-template-columns: 350px 1fr 350px; gap: 20px; height: calc(100vh - 60px); box-sizing: border-box; }

        /* Panels */
        .panel { background-color: var(--bg-panel); border-radius: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { padding: 15px 20px; border-bottom: 1px solid var(--border); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }

        /* 1. Live Feed (Middle - Visual Focus) */
        .feed-container { position: relative; height: 100%; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .feed-placeholder { width: 100%; height: 100%; object-fit: cover; opacity: 0.3; }

        /* Gift Overlay in Feed */
        .gift-overlay {
            position: absolute; bottom: 50px; left: 20px; right: 20px;
            background: rgba(0,0,0,0.8); border: 1px solid var(--border);
            border-radius: 12px; padding: 15px;
            display: flex; align-items: center; gap: 15px;
            transform: translateY(100px); opacity: 0; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s;
        }
        .gift-overlay.active { transform: translateY(0); opacity: 1; }
        .gift-overlay img.gift-img { width: 60px; height: 60px; object-fit: contain; }
        .gift-overlay .info { display: flex; flex-direction: column; }
        .gift-overlay .user { color: var(--accent); font-weight: bold; font-size: 1.1rem; }
        .gift-overlay .action { color: var(--text-main); font-size: 0.9rem; }
        .gift-overlay .combo { color: var(--primary); font-size: 1.5rem; font-weight: 900; margin-left: auto; font-style: italic; }

        /* 2. Chat (Left/Center) */
        .chat-list { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .chat-item { display: flex; align-items: flex-start; gap: 10px; padding: 5px; animation: fadeIn 0.3s ease; }
        .chat-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--bg-card); object-fit: cover; border: 1px solid var(--border); flex-shrink: 0; }
        .chat-content { display: flex; flex-direction: column; }
        .chat-name { font-size: 0.8rem; color: var(--text-dim); font-weight: 600; margin-bottom: 2px; }
        .chat-text { font-size: 0.9rem; color: var(--text-main); line-height: 1.3; }

        /* 3. Event Log (Right) */
        .event-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .event-card {
            background-color: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px;
            display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease;
        }
        .event-card.type-gift { border-left: 3px solid var(--primary); }
        .event-card.type-follow { border-left: 3px solid var(--accent); }

        .event-icon { width: 40px; height: 40px; border-radius: 8px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .event-icon img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        .event-details { flex: 1; }
        .event-title { font-weight: 700; font-size: 0.9rem; color: var(--text-main); display: flex; align-items: center; gap: 5px; }
        .event-subtitle { font-size: 0.8rem; color: var(--text-dim); margin-top: 2px; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><span>TK</span> EVENT SERVER</div>
        <div class="menu-item active">‚ö° Live Dashboard</div>
        <div class="menu-item">üìä Statistics (Soon)</div>
        <div class="menu-item">‚öôÔ∏è Settings (Soon)</div>
    </div>

    <div class="main">
        <div class="header">
            <div class="page-title">Live Overview</div>
            <div class="status-badge" id="ws-status">‚óè CONNECTING...</div>
        </div>

        <div class="dashboard-grid">

            <div class="panel">
                <div class="feed-container">
                    <img src="https://via.placeholder.com/350x620/1a1d29/2f3342?text=Stream+Preview" class="feed-placeholder">

                    <div id="gift-overlay" class="gift-overlay">
                        <img id="gift-overlay-img" class="gift-img" src="" alt="Gift">
                        <div class="info">
                            <span id="gift-overlay-user" class="user">User</span>
                            <span id="gift-overlay-name" class="action">sent Rose</span>
                        </div>
                        <span id="gift-overlay-combo" class="combo">x1</span>
                    </div>
                </div>
                <div class="panel-header" style="border-top: 1px solid var(--border);">
                    <span>Live Feed (1080x1920)</span>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span>Live Chat</span>
                    <span style="font-size: 0.8rem; color: var(--accent);" id="chat-status">‚óè Waiting</span>
                </div>
                <div id="chat-list" class="chat-list">
                    </div>
            </div>

            <div class="panel">
                <div class="panel-header"><span>Event Log</span></div>
                <div id="event-list" class="event-list">
                    </div>
            </div>

        </div>
    </div>

    <script>
        const chatList = document.getElementById('chat-list');
        const eventList = document.getElementById('event-list');
        const giftOverlay = document.getElementById('gift-overlay');
        const statusBadge = document.getElementById('ws-status');
        const chatStatus = document.getElementById('chat-status');

        let giftTimeout;

        function connect() {
            const wsUrl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/overlay/ws";
            const ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                statusBadge.textContent = "‚óè LIVE STREAM ACTIVE";
                statusBadge.style.color = "var(--primary)";
                statusBadge.style.borderColor = "rgba(255, 0, 80, 0.3)";
                statusBadge.style.backgroundColor = "rgba(255, 0, 80, 0.2)";

                chatStatus.textContent = "‚óè Connected";
                console.log("Connected to Core via WebSocket");
            };

            ws.onmessage = (event) => {
                try {
                    const cmd = JSON.parse(event.data);

                    if (cmd.kind === 'toast') {
                        // Decide if it's chat or generic toast
                        if (cmd.title && cmd.title.startsWith("Chat ")) {
                            // Treat as Chat
                            // cmd.title is "Chat Nickname"
                            const nick = cmd.title.replace("Chat ", "");
                            addChat({ title: nick, text: cmd.text, userImage: cmd.userImage });
                        } else if (cmd.title === "Like" || cmd.title === "Share" || cmd.title === "Follow" || cmd.title.includes("ABO") || cmd.title.includes("FRAGE")) {
                            // Treat as Event
                             addEvent(cmd);
                        }
                    } else if (cmd.kind === 'gift') {
                        addEvent(cmd);
                        showGiftOverlay(cmd);
                    } else if (cmd.kind === 'dashboard-update') {
                        // Handle stats update if we had elements for it
                    }
                } catch(e) {
                    console.error(e);
                }
            };

            ws.onclose = () => {
                statusBadge.textContent = "‚óè DISCONNECTED";
                statusBadge.style.color = "gray";
                statusBadge.style.borderColor = "gray";
                statusBadge.style.backgroundColor = "rgba(100, 100, 100, 0.2)";

                console.log("Disconnected. Reconnecting...");
                setTimeout(connect, 3000);
            };
        }

        function addChat(data) {
            const div = document.createElement('div');
            div.className = 'chat-item';
            // Use avatar or fallback
            const avatarUrl = data.userImage || `https://api.dicebear.com/9.x/avataaars/svg?seed=${data.title}`;

            div.innerHTML = `
                <img src="${avatarUrl}" class="chat-avatar" alt="av">
                <div class="chat-content">
                    <span class="chat-name">${data.title}</span>
                    <span class="chat-text">${data.text}</span>
                </div>
            `;
            chatList.appendChild(div);
            chatList.scrollTop = chatList.scrollHeight;

            // Limit history
            if (chatList.children.length > 50) chatList.removeChild(chatList.firstChild);
        }

        function addEvent(data) {
            const div = document.createElement('div');
            let typeClass = 'type-generic';
            let iconHtml = '<div class="event-icon">üì¢</div>';
            let title = data.title || "Event";
            let sub = data.text;

            if (data.kind === 'gift') {
                typeClass = 'type-gift';
                const giftIcon = data.giftIconUrl || '';
                iconHtml = `<div class="event-icon"><img src="${giftIcon}" onerror="this.style.display='none'">üéÅ</div>`;
                title = data.from;
                sub = `sent ${data.giftName} x${data.count}`;
            } else if (data.title === 'Follow' || (data.text && data.text.includes('followed'))) {
                typeClass = 'type-follow';
                iconHtml = '<div class="event-icon">‚ûï</div>';
            }

            div.className = `event-card ${typeClass}`;
            div.innerHTML = `
                ${iconHtml}
                <div class="event-details">
                    <div class="event-title">${title}</div>
                    <div class="event-subtitle">${sub}</div>
                </div>
            `;
            eventList.prepend(div);
            if (eventList.children.length > 20) eventList.removeChild(eventList.lastChild);
        }

        function showGiftOverlay(data) {
            document.getElementById('gift-overlay-img').src = data.giftIconUrl || '';
            document.getElementById('gift-overlay-user').innerText = data.from;
            document.getElementById('gift-overlay-name').innerText = `sent ${data.giftName}`;
            document.getElementById('gift-overlay-combo').innerText = `x${data.count}`;

            giftOverlay.classList.add('active');

            clearTimeout(giftTimeout);
            giftTimeout = setTimeout(() => {
                giftOverlay.classList.remove('active');
            }, data.ms || 3000);
        }

        connect();
    </script>
</body>
</html>
